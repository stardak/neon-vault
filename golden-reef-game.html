<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Golden Reef ‚Äî Slot Game</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Outfit:wght@300;400;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --ocean-deep: #040c1b;
    --ocean-mid: #0a1e3d;
    --ocean-light: #0f2d5e;
    --gold-bright: #ffd700;
    --gold-warm: #f4a425;
    --gold-dim: #9e7318;
    --coral: #ff6b5a;
    --teal: #00d4aa;
    --pearl: #e8e0d0;
    --sand: #c4a35a;
  }

  body {
    background: var(--ocean-deep);
    font-family: 'Outfit', sans-serif;
    color: white;
    overflow: hidden;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* === BACKGROUND EFFECTS === */
  .ocean-bg {
    position: fixed; inset: 0; z-index: 0;
    background: radial-gradient(ellipse at 50% 120%, #0a2d5e 0%, #061430 40%, #020810 80%);
  }

  .bubbles {
    position: fixed; inset: 0; z-index: 1; pointer-events: none; overflow: hidden;
  }
  .bubble {
    position: absolute;
    bottom: -20px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), rgba(255,255,255,0.03));
    border: 1px solid rgba(255,255,255,0.08);
    animation: rise linear infinite;
  }
  @keyframes rise {
    0% { transform: translateY(0) translateX(0) scale(1); opacity: 0.6; }
    50% { transform: translateY(-50vh) translateX(20px) scale(1.1); opacity: 0.4; }
    100% { transform: translateY(-105vh) translateX(-10px) scale(0.8); opacity: 0; }
  }

  .light-rays {
    position: fixed; top: -20%; left: 20%; z-index: 1;
    width: 60%; height: 80%;
    background: conic-gradient(from 180deg at 50% 0%,
      transparent 40%, rgba(0,180,220,0.04) 45%, transparent 50%,
      transparent 55%, rgba(0,180,220,0.03) 58%, transparent 62%,
      transparent 70%, rgba(0,180,220,0.02) 73%, transparent 77%);
    pointer-events: none;
    animation: sway 8s ease-in-out infinite;
  }
  @keyframes sway { 0%,100%{transform:rotate(-3deg)} 50%{transform:rotate(3deg)} }

  /* === GAME CONTAINER === */
  .game-wrapper {
    position: relative; z-index: 10;
    width: 900px; max-width: 95vw;
  }

  /* === HEADER === */
  .game-header {
    text-align: center;
    margin-bottom: 16px;
    position: relative;
  }
  .game-title {
    font-family: 'Cinzel', serif;
    font-size: 42px;
    font-weight: 900;
    background: linear-gradient(135deg, #ffd700 0%, #ffec80 30%, #f4a425 60%, #ffd700 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    filter: drop-shadow(0 2px 8px rgba(255,215,0,0.4));
    letter-spacing: 4px;
    text-transform: uppercase;
  }
  .game-subtitle {
    font-size: 13px;
    color: var(--teal);
    letter-spacing: 6px;
    text-transform: uppercase;
    margin-top: 2px;
    opacity: 0.8;
  }

  /* === REEL FRAME === */
  .reel-frame {
    background: linear-gradient(180deg, #0d1f3a 0%, #091428 100%);
    border-radius: 16px;
    padding: 6px;
    border: 2px solid rgba(255,215,0,0.25);
    box-shadow:
      0 0 30px rgba(0,100,180,0.2),
      inset 0 0 40px rgba(0,0,0,0.5),
      0 0 60px rgba(255,215,0,0.08);
    position: relative;
    overflow: hidden;
  }
  .reel-frame::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(180deg, rgba(255,215,0,0.06) 0%, transparent 30%, transparent 70%, rgba(255,215,0,0.04) 100%);
    border-radius: 14px;
    pointer-events: none;
  }

  .reels-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 4px;
    position: relative;
  }

  .reel {
    position: relative;
    height: 300px;
    overflow: hidden;
    border-radius: 8px;
    background: linear-gradient(180deg, rgba(4,12,27,0.9) 0%, rgba(10,30,61,0.8) 50%, rgba(4,12,27,0.9) 100%);
  }

  .reel-strip {
    position: absolute;
    width: 100%;
    transition: none;
  }
  .reel-strip.spinning {
    /* animated via JS */
  }

  .symbol-cell {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .symbol-icon {
    font-size: 48px;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
    transition: transform 0.3s ease;
  }
  .symbol-cell.winning .symbol-icon {
    animation: symbolPulse 0.5s ease-in-out infinite alternate;
  }
  @keyframes symbolPulse {
    0% { transform: scale(1); filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5)); }
    100% { transform: scale(1.15); filter: drop-shadow(0 0 20px rgba(255,215,0,0.8)); }
  }

  /* Reel dividers */
  .reel::after {
    content: '';
    position: absolute; inset: 0;
    border-right: 1px solid rgba(255,215,0,0.08);
    pointer-events: none;
  }
  .reel:last-child::after { border-right: none; }

  /* Row highlight lines */
  .payline-indicator {
    position: absolute;
    left: 0; right: 0;
    height: 100px;
    border-top: 1px solid rgba(255,215,0,0.06);
    border-bottom: 1px solid rgba(255,215,0,0.06);
    pointer-events: none;
    z-index: 5;
  }

  /* === CONTROLS === */
  .controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 16px;
    gap: 12px;
  }

  .control-panel {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(10,30,61,0.6);
    border: 1px solid rgba(255,215,0,0.15);
    border-radius: 12px;
    padding: 10px 20px;
    min-width: 120px;
  }
  .control-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--teal);
    margin-bottom: 4px;
    opacity: 0.7;
  }
  .control-value {
    font-family: 'Cinzel', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--gold-bright);
  }

  .bet-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .bet-btn {
    width: 34px; height: 34px;
    border-radius: 50%;
    border: 1px solid rgba(255,215,0,0.3);
    background: rgba(255,215,0,0.1);
    color: var(--gold-bright);
    font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    font-family: 'Outfit', sans-serif;
  }
  .bet-btn:hover {
    background: rgba(255,215,0,0.25);
    border-color: var(--gold-bright);
    transform: scale(1.1);
  }

  .spin-btn {
    width: 100px; height: 100px;
    border-radius: 50%;
    border: 3px solid var(--gold-bright);
    background: radial-gradient(circle at 40% 35%, #ffd700 0%, #c4841d 70%, #8b5e14 100%);
    color: var(--ocean-deep);
    font-family: 'Cinzel', serif;
    font-size: 16px;
    font-weight: 900;
    letter-spacing: 2px;
    cursor: pointer;
    box-shadow: 0 0 30px rgba(255,215,0,0.3), inset 0 -3px 8px rgba(0,0,0,0.3);
    transition: all 0.2s;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
  }
  .spin-btn::before {
    content: '';
    position: absolute; top: 8px; left: 15%; right: 15%; height: 30%;
    background: linear-gradient(180deg, rgba(255,255,255,0.4), transparent);
    border-radius: 50%;
  }
  .spin-btn:hover:not(:disabled) {
    transform: scale(1.08);
    box-shadow: 0 0 50px rgba(255,215,0,0.5), inset 0 -3px 8px rgba(0,0,0,0.3);
  }
  .spin-btn:active:not(:disabled) { transform: scale(0.95); }
  .spin-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: saturate(0.5);
  }

  /* === WIN DISPLAY === */
  .win-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    text-align: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .win-display.active { opacity: 1; }
  .win-amount {
    font-family: 'Cinzel', serif;
    font-size: 60px;
    font-weight: 900;
    background: linear-gradient(135deg, #ffd700, #ffec80, #f4a425);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 20px rgba(255,215,0,0.6)) drop-shadow(0 4px 12px rgba(0,0,0,0.8));
    animation: winPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .win-label {
    font-size: 14px;
    letter-spacing: 4px;
    color: var(--teal);
    text-transform: uppercase;
    margin-top: -4px;
    text-shadow: 0 0 10px rgba(0,212,170,0.5);
  }
  @keyframes winPop {
    0% { transform: scale(0.3); opacity: 0; }
    60% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
  }

  /* === SCATTER / FREE SPINS BANNER === */
  .feature-banner {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 150;
    text-align: center;
    pointer-events: none;
    opacity: 0;
  }
  .feature-banner.active {
    opacity: 1;
    animation: bannerIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .feature-banner h2 {
    font-family: 'Cinzel', serif;
    font-size: 36px;
    color: var(--coral);
    text-shadow: 0 0 30px rgba(255,107,90,0.6);
    letter-spacing: 3px;
  }
  .feature-banner p {
    font-size: 48px;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    color: var(--gold-bright);
    text-shadow: 0 0 30px rgba(255,215,0,0.6);
  }
  @keyframes bannerIn {
    0% { transform: translate(-50%, -50%) scale(0.1) rotate(-10deg); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1) rotate(0); opacity: 1; }
  }

  /* === PAYTABLE TOGGLE === */
  .paytable-btn {
    position: absolute;
    top: 8px; right: 8px;
    background: rgba(255,215,0,0.1);
    border: 1px solid rgba(255,215,0,0.2);
    color: var(--gold-dim);
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    font-family: 'Outfit', sans-serif;
    letter-spacing: 1px;
    z-index: 20;
    transition: all 0.2s;
  }
  .paytable-btn:hover {
    background: rgba(255,215,0,0.2);
    color: var(--gold-bright);
  }

  .paytable-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(4,12,27,0.95);
    z-index: 200;
    border-radius: 14px;
    padding: 24px;
    overflow-y: auto;
  }
  .paytable-overlay.open { display: block; }
  .paytable-overlay h3 {
    font-family: 'Cinzel', serif;
    color: var(--gold-bright);
    margin-bottom: 16px;
    text-align: center;
    font-size: 20px;
  }
  .pay-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .pay-row .sym { font-size: 28px; width: 40px; text-align: center; }
  .pay-row .pays {
    display: flex; gap: 16px;
    font-size: 13px; color: var(--pearl);
  }
  .pay-row .pays span {
    min-width: 80px;
  }
  .pay-row .pays .mult { color: var(--gold-warm); font-weight: 600; }
  .close-paytable {
    display: block;
    margin: 16px auto 0;
    padding: 8px 24px;
    border-radius: 8px;
    border: 1px solid var(--gold-dim);
    background: transparent;
    color: var(--gold-bright);
    cursor: pointer;
    font-family: 'Outfit', sans-serif;
  }

  /* === INFO BAR === */
  .info-bar {
    text-align: center;
    margin-top: 8px;
    font-size: 12px;
    color: rgba(255,255,255,0.35);
    letter-spacing: 1px;
  }
  .info-bar .rtp { color: var(--teal); opacity: 0.6; }

  /* === RESPONSIVE === */
  @media (max-width: 700px) {
    .game-title { font-size: 28px; }
    .reel { height: 210px; }
    .symbol-cell { height: 70px; }
    .symbol-icon { font-size: 34px; }
    .spin-btn { width: 72px; height: 72px; font-size: 12px; }
    .control-panel { padding: 6px 12px; min-width: 80px; }
    .control-value { font-size: 16px; }
    .win-amount { font-size: 40px; }
  }
</style>
</head>
<body>

<div class="ocean-bg"></div>
<div class="light-rays"></div>
<div class="bubbles" id="bubbles"></div>

<div class="game-wrapper">
  <div class="game-header">
    <div class="game-title">Golden Reef</div>
    <div class="game-subtitle">‚öì Underwater Treasures ‚öì</div>
  </div>

  <div class="reel-frame" id="reelFrame">
    <button class="paytable-btn" id="paytableBtn">PAYS</button>

    <div class="reels-container" id="reelsContainer">
      <!-- Reels generated by JS -->
    </div>

    <div class="win-display" id="winDisplay">
      <div class="win-amount" id="winAmount"></div>
      <div class="win-label">WIN</div>
    </div>

    <div class="feature-banner" id="featureBanner">
      <h2 id="featureTitle"></h2>
      <p id="featureValue"></p>
    </div>

    <div class="paytable-overlay" id="paytableOverlay">
      <h3>‚Äî PAYTABLE ‚Äî</h3>
      <div id="paytableContent"></div>
      <button class="close-paytable" id="closePaytable">CLOSE</button>
    </div>
  </div>

  <div class="controls">
    <div class="control-panel">
      <div class="control-label">Balance</div>
      <div class="control-value" id="balanceDisplay">1,000</div>
    </div>

    <div class="control-panel">
      <div class="control-label">Bet</div>
      <div class="bet-controls">
        <button class="bet-btn" id="betDown">‚àí</button>
        <div class="control-value" id="betDisplay">1.00</div>
        <button class="bet-btn" id="betUp">+</button>
      </div>
    </div>

    <button class="spin-btn" id="spinBtn">SPIN</button>

    <div class="control-panel">
      <div class="control-label">Win</div>
      <div class="control-value" id="lastWinDisplay">0.00</div>
    </div>

    <div class="control-panel">
      <div class="control-label">Lines</div>
      <div class="control-value">20</div>
    </div>
  </div>

  <div class="info-bar">
    GOLDEN REEF v1.0 ¬∑ 5√ó3 ¬∑ 20 PAYLINES ¬∑ <span class="rtp">RTP 96.5%</span>
  </div>
</div>

<script>
// ============================================================
// GOLDEN REEF ‚Äî Game Engine (Client-Side Demo)
// ============================================================

const SYMBOL_MAP = {
  'WILD':    { emoji: 'üè¥‚Äç‚ò†Ô∏è', name: 'Treasure Chest' },
  'SCATTER': { emoji: 'üß≠',  name: 'Golden Compass' },
  'HIGH1':   { emoji: 'ü™ô',  name: 'Gold Coin' },
  'HIGH2':   { emoji: 'ü¶™',  name: 'Pearl' },
  'HIGH3':   { emoji: '‚≠ê',  name: 'Starfish' },
  'LOW1':    { emoji: 'üêö',  name: 'Seahorse' },
  'LOW2':    { emoji: 'üê°',  name: 'Shell' },
  'LOW3':    { emoji: 'ü™∏',  name: 'Coral' },
  'LOW4':    { emoji: '‚öì',  name: 'Anchor' },
};

const REEL_STRIPS = [
  ["LOW4","LOW2","HIGH3","LOW1","LOW3","HIGH2","LOW4","LOW1","LOW2","HIGH1","LOW3","LOW4","SCATTER","LOW1","HIGH3","LOW2","LOW3","LOW4","HIGH2","LOW1","WILD","LOW2","LOW3","LOW4","HIGH3","LOW1","LOW2","LOW3","HIGH1","LOW4","LOW1","LOW2"],
  ["LOW1","HIGH3","LOW4","LOW2","LOW3","HIGH1","LOW4","SCATTER","LOW2","HIGH2","LOW1","LOW3","LOW4","HIGH3","LOW2","LOW1","LOW3","WILD","LOW4","LOW2","HIGH2","LOW1","LOW3","LOW4","LOW2","HIGH3","LOW1","LOW3","LOW4","LOW2","LOW1","HIGH1"],
  ["LOW3","LOW1","HIGH2","LOW4","LOW2","HIGH3","LOW1","LOW3","SCATTER","LOW2","HIGH1","LOW4","LOW1","LOW3","LOW2","HIGH2","LOW4","LOW1","WILD","LOW3","LOW2","HIGH3","LOW4","LOW1","LOW2","LOW3","HIGH1","LOW4","LOW1","LOW2","LOW3","LOW4"],
  ["LOW2","LOW4","HIGH1","LOW1","LOW3","HIGH3","LOW2","LOW4","LOW1","HIGH2","LOW3","SCATTER","LOW4","LOW2","HIGH3","LOW1","LOW3","LOW4","HIGH2","LOW2","LOW1","WILD","LOW3","LOW4","HIGH1","LOW2","LOW1","LOW3","LOW4","LOW2","HIGH3","LOW1"],
  ["LOW4","LOW1","HIGH3","LOW2","LOW3","HIGH2","LOW4","LOW1","LOW2","HIGH1","LOW3","LOW4","LOW1","SCATTER","HIGH3","LOW2","WILD","LOW3","LOW4","HIGH2","LOW1","LOW2","LOW3","LOW4","HIGH1","LOW1","LOW2","LOW3","LOW4","HIGH3","LOW2","LOW1"],
];

const PAYTABLE = {
  'WILD':  [108.0, 540.0, 2700.0],
  'HIGH1': [54.0, 200.0, 1080.0],
  'HIGH2': [40.0, 135.0, 675.0],
  'HIGH3': [27.0, 108.0, 405.0],
  'LOW1':  [13.5, 54.0, 200.0],
  'LOW2':  [10.8, 40.0, 135.0],
  'LOW3':  [8.0, 27.0, 108.0],
  'LOW4':  [5.4, 20.0, 80.0],
};

const SCATTER_PAY = { 3: 4.0, 4: 20.0, 5: 135.0 };
const FREE_SPINS = { 3: 10, 4: 15, 5: 25 };
const NUM_LINES = 20;

const PAYLINES = [
  [1,1,1,1,1],[0,0,0,0,0],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2],
  [0,0,1,2,2],[2,2,1,0,0],[1,0,0,0,1],[1,2,2,2,1],[0,1,1,1,0],
  [2,1,1,1,2],[1,0,1,0,1],[1,2,1,2,1],[0,1,0,1,0],[2,1,2,1,2],
  [1,1,0,1,1],[1,1,2,1,1],[0,0,1,0,0],[2,2,1,2,2],[0,2,0,2,0],
];

// === STATE ===
let balance = 1000;
let bet = 1;
let isSpinning = false;
const betLevels = [0.10, 0.25, 0.50, 1.00, 2.00, 5.00, 10.00, 25.00, 50.00];
let betIndex = 3;

// === DOM ===
const reelsContainer = document.getElementById('reelsContainer');
const spinBtn = document.getElementById('spinBtn');
const balanceDisplay = document.getElementById('balanceDisplay');
const betDisplay = document.getElementById('betDisplay');
const lastWinDisplay = document.getElementById('lastWinDisplay');
const winDisplay = document.getElementById('winDisplay');
const winAmount = document.getElementById('winAmount');
const featureBanner = document.getElementById('featureBanner');
const featureTitle = document.getElementById('featureTitle');
const featureValue = document.getElementById('featureValue');

// === INIT BUBBLES ===
function createBubbles() {
  const container = document.getElementById('bubbles');
  for (let i = 0; i < 20; i++) {
    const b = document.createElement('div');
    b.className = 'bubble';
    b.style.left = Math.random() * 100 + '%';
    b.style.width = b.style.height = (4 + Math.random() * 16) + 'px';
    b.style.animationDuration = (6 + Math.random() * 10) + 's';
    b.style.animationDelay = Math.random() * 8 + 's';
    container.appendChild(b);
  }
}
createBubbles();

// === INIT REELS ===
// Each reel shows 3 symbols + extra for scrolling animation
const reelElements = [];
const currentStops = [0, 0, 0, 0, 0];

function getSymbolAt(reel, pos) {
  const strip = REEL_STRIPS[reel];
  return strip[((pos % strip.length) + strip.length) % strip.length];
}

function createReels() {
  reelsContainer.innerHTML = '';
  for (let r = 0; r < 5; r++) {
    const reel = document.createElement('div');
    reel.className = 'reel';

    const strip = document.createElement('div');
    strip.className = 'reel-strip';
    strip.id = `strip-${r}`;

    // Render enough symbols for spinning animation (30 + 3 visible)
    const totalSymbols = 33;
    for (let i = 0; i < totalSymbols; i++) {
      const cell = document.createElement('div');
      cell.className = 'symbol-cell';
      const icon = document.createElement('div');
      icon.className = 'symbol-icon';
      const sym = getSymbolAt(r, i);
      icon.textContent = SYMBOL_MAP[sym].emoji;
      icon.dataset.symbol = sym;
      cell.appendChild(icon);
      strip.appendChild(cell);
    }

    reel.appendChild(strip);
    reelsContainer.appendChild(reel);
    reelElements.push(strip);
  }
  updateReelPositions(false);
}

function updateReelPositions(animate = true) {
  for (let r = 0; r < 5; r++) {
    const strip = reelElements[r];
    // Rebuild visible symbols at current stop
    const cells = strip.querySelectorAll('.symbol-cell');
    for (let i = 0; i < cells.length; i++) {
      const sym = getSymbolAt(r, currentStops[r] + i);
      const icon = cells[i].querySelector('.symbol-icon');
      icon.textContent = SYMBOL_MAP[sym].emoji;
      icon.dataset.symbol = sym;
      cells[i].classList.remove('winning');
    }
    strip.style.transition = 'none';
    strip.style.transform = 'translateY(0)';
  }
}

createReels();

// === GAME LOGIC ===
function evaluatePayline(grid, payline) {
  const symbols = payline.map((row, reel) => grid[reel][row]);
  let paySymbol = null;
  for (const s of symbols) {
    if (s === 'SCATTER') return null;
    if (s !== 'WILD') { paySymbol = s; break; }
  }
  if (!paySymbol) paySymbol = 'WILD';

  let count = 0;
  for (const s of symbols) {
    if (s === paySymbol || s === 'WILD') count++;
    else break;
  }

  if (count < 3 || !PAYTABLE[paySymbol]) return null;
  return { symbol: paySymbol, count, payout: PAYTABLE[paySymbol][count - 3], positions: payline.slice(0, count) };
}

function evaluateSpin(stops) {
  const grid = [];
  for (let r = 0; r < 5; r++) {
    grid.push([
      getSymbolAt(r, stops[r]),
      getSymbolAt(r, stops[r] + 1),
      getSymbolAt(r, stops[r] + 2),
    ]);
  }

  const lineWins = [];
  let totalLinePayout = 0;
  for (let l = 0; l < PAYLINES.length; l++) {
    const win = evaluatePayline(grid, PAYLINES[l]);
    if (win) {
      lineWins.push({ ...win, line: l });
      totalLinePayout += win.payout;
    }
  }

  let scatterCount = 0;
  const scatterPositions = [];
  for (let r = 0; r < 5; r++) {
    for (let row = 0; row < 3; row++) {
      if (grid[r][row] === 'SCATTER') {
        scatterCount++;
        scatterPositions.push({ reel: r, row });
      }
    }
  }

  const scatterPayout = SCATTER_PAY[scatterCount] || 0;
  const freeSpins = FREE_SPINS[scatterCount] || 0;
  const totalPayout = (totalLinePayout / NUM_LINES) + scatterPayout;

  return { grid, lineWins, scatterCount, scatterPositions, scatterPayout, freeSpins, totalPayout };
}

// === SPIN ANIMATION ===
async function spin() {
  if (isSpinning || balance < bet) return;
  isSpinning = true;
  spinBtn.disabled = true;

  // Deduct bet
  balance -= bet;
  updateUI();

  // Hide previous wins
  winDisplay.classList.remove('active');
  featureBanner.classList.remove('active');
  lastWinDisplay.textContent = '0.00';

  // Generate random stops
  const newStops = REEL_STRIPS.map(strip => Math.floor(Math.random() * strip.length));

  // Animate each reel with staggered timing
  const spinPromises = reelElements.map((strip, r) => {
    return new Promise(resolve => {
      const cellHeight = 100;
      const extraSpins = 8 + r * 3; // More rotations for later reels
      const totalCells = extraSpins;
      const duration = 600 + r * 250;

      // Rebuild symbols: first show current, then random spin symbols, then final 3
      const cells = strip.querySelectorAll('.symbol-cell');
      // Fill with random symbols for the spin
      for (let i = 0; i < cells.length - 3; i++) {
        const randSym = REEL_STRIPS[r][Math.floor(Math.random() * REEL_STRIPS[r].length)];
        const icon = cells[i].querySelector('.symbol-icon');
        icon.textContent = SYMBOL_MAP[randSym].emoji;
        icon.dataset.symbol = randSym;
        cells[i].classList.remove('winning');
      }
      // Last 3 cells are the final result
      for (let i = 0; i < 3; i++) {
        const sym = getSymbolAt(r, newStops[r] + i);
        const icon = cells[cells.length - 3 + i].querySelector('.symbol-icon');
        icon.textContent = SYMBOL_MAP[sym].emoji;
        icon.dataset.symbol = sym;
        cells[cells.length - 3 + i].classList.remove('winning');
      }

      // Animate strip moving up
      const totalDist = (cells.length - 3) * cellHeight;
      strip.style.transition = 'none';
      strip.style.transform = 'translateY(0)';

      requestAnimationFrame(() => {
        strip.style.transition = `transform ${duration}ms cubic-bezier(0.15, 0.8, 0.3, 1.02)`;
        strip.style.transform = `translateY(-${totalDist}px)`;
      });

      setTimeout(() => {
        currentStops[r] = newStops[r];
        // Reset position with final symbols
        strip.style.transition = 'none';
        const allCells = strip.querySelectorAll('.symbol-cell');
        for (let i = 0; i < allCells.length; i++) {
          const sym = getSymbolAt(r, newStops[r] + i);
          const icon = allCells[i].querySelector('.symbol-icon');
          icon.textContent = SYMBOL_MAP[sym].emoji;
          icon.dataset.symbol = sym;
        }
        strip.style.transform = 'translateY(0)';
        resolve();
      }, duration + 50);
    });
  });

  await Promise.all(spinPromises);

  // Evaluate result
  const result = evaluateSpin(newStops);
  const winValue = result.totalPayout * bet;

  // Show wins
  if (winValue > 0) {
    balance += winValue;
    lastWinDisplay.textContent = winValue.toFixed(2);

    // Highlight winning symbols
    if (result.lineWins.length > 0) {
      highlightWins(result);
    }

    // Show win display
    winAmount.textContent = winValue.toFixed(2);
    winDisplay.classList.add('active');

    // Big win effect
    if (result.totalPayout >= 10) {
      createWinParticles();
    }
  }

  // Free spins trigger
  if (result.freeSpins > 0) {
    await new Promise(r => setTimeout(r, 800));
    featureTitle.textContent = 'üß≠ FREE SPINS üß≠';
    featureValue.textContent = `${result.freeSpins} SPINS!`;
    featureBanner.classList.add('active');
    setTimeout(() => featureBanner.classList.remove('active'), 3000);
  }

  updateUI();
  isSpinning = false;
  spinBtn.disabled = false;
}

function highlightWins(result) {
  // Find all winning positions
  const winningCells = new Set();
  for (const win of result.lineWins) {
    const payline = PAYLINES[win.line];
    for (let r = 0; r < win.count; r++) {
      winningCells.add(`${r}-${payline[r]}`);
    }
  }
  // Also highlight scatters
  for (const sp of result.scatterPositions) {
    winningCells.add(`${sp.reel}-${sp.row}`);
  }

  // Apply winning class
  for (const key of winningCells) {
    const [reel, row] = key.split('-').map(Number);
    const strip = reelElements[reel];
    const cell = strip.querySelectorAll('.symbol-cell')[row];
    if (cell) cell.classList.add('winning');
  }
}

function createWinParticles() {
  const frame = document.getElementById('reelFrame');
  for (let i = 0; i < 30; i++) {
    const particle = document.createElement('div');
    particle.style.cssText = `
      position: absolute;
      width: 6px; height: 6px;
      background: ${['#ffd700', '#ff6b5a', '#00d4aa', '#ffec80'][Math.floor(Math.random() * 4)]};
      border-radius: 50%;
      left: ${30 + Math.random() * 40}%;
      top: ${30 + Math.random() * 40}%;
      z-index: 200;
      pointer-events: none;
      animation: particle ${0.6 + Math.random() * 1}s ease-out forwards;
    `;
    frame.appendChild(particle);
    setTimeout(() => particle.remove(), 2000);
  }

  // Add particle animation if not exists
  if (!document.getElementById('particleStyle')) {
    const style = document.createElement('style');
    style.id = 'particleStyle';
    style.textContent = `
      @keyframes particle {
        0% { transform: translate(0, 0) scale(1); opacity: 1; }
        100% { transform: translate(${-100 + Math.random() * 200}px, ${-150 + Math.random() * 100}px) scale(0); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
}

// === UI UPDATES ===
function updateUI() {
  balanceDisplay.textContent = balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  betDisplay.textContent = bet.toFixed(2);
}

// === CONTROLS ===
spinBtn.addEventListener('click', spin);

document.getElementById('betUp').addEventListener('click', () => {
  if (isSpinning) return;
  if (betIndex < betLevels.length - 1) {
    betIndex++;
    bet = betLevels[betIndex];
    updateUI();
  }
});

document.getElementById('betDown').addEventListener('click', () => {
  if (isSpinning) return;
  if (betIndex > 0) {
    betIndex--;
    bet = betLevels[betIndex];
    updateUI();
  }
});

// Spacebar to spin
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space') { e.preventDefault(); spin(); }
});

// === PAYTABLE ===
function buildPaytable() {
  const content = document.getElementById('paytableContent');
  const symbols = ['WILD', 'HIGH1', 'HIGH2', 'HIGH3', 'LOW1', 'LOW2', 'LOW3', 'LOW4'];

  let html = '';
  for (const sym of symbols) {
    const pay = PAYTABLE[sym];
    html += `<div class="pay-row">
      <div class="sym">${SYMBOL_MAP[sym].emoji}</div>
      <div class="pays">
        <span>3√ó <span class="mult">${(pay[0]/NUM_LINES).toFixed(2)}x</span></span>
        <span>4√ó <span class="mult">${(pay[1]/NUM_LINES).toFixed(2)}x</span></span>
        <span>5√ó <span class="mult">${(pay[2]/NUM_LINES).toFixed(2)}x</span></span>
      </div>
    </div>`;
  }

  html += `<div class="pay-row" style="margin-top:12px; border-top: 1px solid rgba(255,215,0,0.15); padding-top: 8px;">
    <div class="sym">${SYMBOL_MAP.SCATTER.emoji}</div>
    <div class="pays">
      <span>3√ó <span class="mult">4x + 10 FS</span></span>
      <span>4√ó <span class="mult">20x + 15 FS</span></span>
      <span>5√ó <span class="mult">135x + 25 FS</span></span>
    </div>
  </div>`;

  content.innerHTML = html;
}
buildPaytable();

document.getElementById('paytableBtn').addEventListener('click', () => {
  document.getElementById('paytableOverlay').classList.add('open');
});
document.getElementById('closePaytable').addEventListener('click', () => {
  document.getElementById('paytableOverlay').classList.remove('open');
});

updateUI();
</script>
</body>
</html>
