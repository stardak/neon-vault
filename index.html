<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON VAULT ‚Äî Cyberpunk Slot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --neon-cyan: #00f0ff;
            --neon-magenta: #ff00aa;
            --neon-purple: #b400ff;
            --neon-yellow: #ffe600;
            --neon-green: #00ff88;
            --bg-deep: #05050f;
            --bg-panel: rgba(8, 12, 30, 0.85);
            --glass-border: rgba(0, 240, 255, 0.15);
            --glass-shine: rgba(0, 240, 255, 0.05);
            --text-primary: #e0f0ff;
            --text-dim: rgba(180, 210, 255, 0.5);
        }

        body {
            background: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            color: var(--text-primary);
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,240,255,0.015) 2px, rgba(0,240,255,0.015) 4px);
            pointer-events: none;
            z-index: 9999;
        }

        #game-wrapper {
            position: relative;
            width: 900px;
            max-width: 100vw;
            display: flex;
            flex-direction: column;
            padding: 0 8px;
            box-sizing: border-box;
        }

        #game-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 0 8px;
            position: relative;
        }
        #game-title {
            height: 50px;
            width: auto;
            object-fit: contain;
            animation: titleFlicker 4s infinite;
        }
        @keyframes titleFlicker {
            0%,100% { opacity:1; }
            92% { opacity:1; }
            93% { opacity:0.7; }
            94% { opacity:1; }
            96% { opacity:0.75; }
            97% { opacity:1; }
        }
        .header-line { position:absolute; bottom:0; left:5%; right:5%; height:1px; background:linear-gradient(90deg,transparent,var(--neon-cyan),var(--neon-magenta),var(--neon-cyan),transparent); opacity:0.4; }

        #info-strip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            letter-spacing: 1.5px;
            color: var(--text-dim);
        }
        #info-strip span { color: var(--neon-cyan); opacity: 0.7; }
        .info-left { display: flex; gap: 28px; }

        #bonus-meter-wrap {
            display:flex; align-items:center; gap:12px;
            background: rgba(255,0,170,0.04);
            border: 1px solid rgba(255,0,170,0.12);
            border-radius: 10px;
            padding: 6px 16px 6px 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        #bonus-meter-wrap::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,0,170,0.03), transparent);
            animation: meterSweep 3s linear infinite;
        }
        @keyframes meterSweep {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        #bonus-meter-icon {
            font-size: 18px;
            filter: drop-shadow(0 0 6px rgba(255,0,170,0.4));
            animation: iconPulse 2s ease-in-out infinite;
        }
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        #bonus-meter-label {
            font-family:'Orbitron',monospace; font-size:9px; font-weight:700; letter-spacing:2.5px;
            color:var(--neon-magenta); text-shadow:0 0 10px rgba(255,0,170,0.4);
        }
        #bonus-meter-mid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        #bonus-meter-track {
            width:160px; height:10px; background:rgba(255,0,170,0.06);
            border:1px solid rgba(255,0,170,0.15); border-radius:5px; overflow:hidden; position:relative;
            display: flex; gap: 2px; padding: 2px;
        }
        .meter-segment {
            flex: 1;
            height: 100%;
            border-radius: 2px;
            background: rgba(255,0,170,0.08);
            transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
            position: relative;
            overflow: hidden;
        }
        .meter-segment.filled {
            background: linear-gradient(180deg, var(--neon-magenta), var(--neon-purple));
            box-shadow: 0 0 6px rgba(255,0,170,0.5);
        }
        .meter-segment.filled::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: liquidShimmer 2s ease-in-out infinite;
            animation-delay: calc(var(--seg-index, 0) * 0.12s);
        }
        @keyframes liquidShimmer {
            0%,100% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(100%); opacity: 1; }
        }
        .meter-segment.filled.recent {
            animation: segFill 0.5s cubic-bezier(0.34,1.56,0.64,1);
        }
        @keyframes segFill {
            0% { transform: scaleY(0.2) scaleX(0.5); opacity: 0.3; background:var(--neon-yellow); }
            40% { transform: scaleY(1.4) scaleX(1.1); }
            70% { transform: scaleY(0.9); }
            100% { transform: scaleY(1) scaleX(1); opacity: 1; }
        }
        #bonus-meter-pct {
            font-family:'Orbitron',monospace; font-size:14px; font-weight:800;
            color:var(--neon-magenta); text-shadow:0 0 10px rgba(255,0,170,0.4);
            min-width: 42px; text-align: right;
            transition: all 0.3s;
        }

        /* Hot state ‚Äî close to triggering */
        #bonus-meter-wrap.hot {
            border-color: rgba(255,0,170,0.35);
            background: rgba(255,0,170,0.08);
            box-shadow: 0 0 20px rgba(255,0,170,0.12), inset 0 0 20px rgba(255,0,170,0.04);
            animation: meterPulse 1.2s ease-in-out infinite;
        }
        @keyframes meterPulse {
            0%,100% { box-shadow: 0 0 20px rgba(255,0,170,0.12), inset 0 0 20px rgba(255,0,170,0.04); }
            50% { box-shadow: 0 0 35px rgba(255,0,170,0.25), inset 0 0 30px rgba(255,0,170,0.08), 0 0 60px rgba(255,0,170,0.1); }
        }
        #bonus-meter-wrap.hot #bonus-meter-pct {
            color: var(--neon-yellow);
            text-shadow: 0 0 12px rgba(255,230,0,0.5);
            animation: pctPulse 0.8s ease-in-out infinite alternate;
        }
        #bonus-meter-wrap.hot #bonus-meter-icon {
            animation: iconShake 0.4s ease-in-out infinite;
        }
        @keyframes pctPulse { from{transform:scale(1)} to{transform:scale(1.1)} }
        @keyframes iconShake {
            0%, 100% { transform: rotate(0deg) scale(1.1); }
            25% { transform: rotate(-8deg) scale(1.15); }
            75% { transform: rotate(8deg) scale(1.15); }
        }

        #canvas-container {
            position:relative;
            background:linear-gradient(180deg,rgba(5,5,15,0.9),rgba(10,8,30,0.95));
            border:1px solid var(--glass-border); border-radius:16px; overflow:hidden;
            box-shadow:0 0 40px rgba(0,240,255,0.06),0 0 80px rgba(180,0,255,0.04),inset 0 1px 0 var(--glass-shine);
        }
        #game-canvas { display:block; width:100%; touch-action:manipulation; }
        #controls { -webkit-tap-highlight-color:transparent; }
        button, .bonus-cell { -webkit-tap-highlight-color:transparent; touch-action:manipulation; }

        #win-overlay {
            position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
            pointer-events:none; z-index:30; opacity:0; transition:opacity 0.3s ease-out;
        }
        #win-overlay.show { opacity:1; }
        #win-overlay .win-label { font-family:'Orbitron',monospace; font-size:18px; font-weight:700; letter-spacing:10px; color:var(--neon-cyan); text-shadow:0 0 20px var(--neon-cyan),0 0 40px rgba(0,240,255,0.3); margin-bottom:2px; animation:winLabelIn 0.5s ease-out both; }
        #win-overlay .win-amount { font-family:'Orbitron',monospace; font-size:80px; font-weight:900; background:linear-gradient(180deg,#fff 20%,var(--neon-yellow) 80%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; filter:drop-shadow(0 0 40px rgba(255,230,0,0.7)) drop-shadow(0 0 80px rgba(255,230,0,0.3)); animation:winAmountIn 0.6s cubic-bezier(0.175,0.885,0.32,1.4) both, winGlow 1.2s ease-in-out 0.6s infinite alternate; }
        #win-overlay.mega .win-label { font-size:22px; color:var(--neon-magenta); text-shadow:0 0 20px var(--neon-magenta),0 0 50px rgba(255,0,170,0.4); letter-spacing:12px; }
        #win-overlay.mega .win-amount { font-size:96px; background:linear-gradient(180deg,#fff 10%,#ff6af0 40%,var(--neon-magenta) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter:drop-shadow(0 0 50px rgba(255,0,170,0.8)) drop-shadow(0 0 100px rgba(255,0,170,0.4)); }
        #win-overlay.big .win-amount { font-size:88px; }
        #win-overlay .win-sub { font-family:'Orbitron',monospace; font-size:13px; font-weight:600; letter-spacing:5px; color:rgba(255,230,0,0.7); margin-top:4px; animation:winLabelIn 0.7s ease-out 0.3s both; }
        #win-overlay.mega .win-sub { color:rgba(255,100,240,0.7); }
        @keyframes winLabelIn { from{opacity:0;transform:translateY(10px);letter-spacing:20px;} to{opacity:1;transform:translateY(0);} }
        @keyframes winAmountIn { from{opacity:0;transform:scale(0.3);} to{opacity:1;transform:scale(1);} }
        @keyframes screenShake {
            0%,100%{transform:translate(0,0)}
            10%{transform:translate(-4px,2px)}
            20%{transform:translate(3px,-3px)}
            30%{transform:translate(-3px,1px)}
            40%{transform:translate(2px,-2px)}
            50%{transform:translate(-2px,3px)}
            60%{transform:translate(3px,-1px)}
            70%{transform:translate(-1px,2px)}
            80%{transform:translate(2px,-1px)}
            90%{transform:translate(-1px,1px)}
        }
        @keyframes megaShake {
            0%,100%{transform:translate(0,0)}
            8%{transform:translate(-8px,4px) rotate(-0.5deg)}
            16%{transform:translate(6px,-6px) rotate(0.5deg)}
            24%{transform:translate(-6px,3px) rotate(-0.3deg)}
            32%{transform:translate(5px,-4px) rotate(0.3deg)}
            40%{transform:translate(-4px,5px)}
            48%{transform:translate(4px,-3px)}
            56%{transform:translate(-3px,2px)}
            64%{transform:translate(3px,-2px)}
            72%{transform:translate(-2px,2px)}
            80%{transform:translate(2px,-1px)}
            88%{transform:translate(-1px,1px)}
        }
        #game-wrapper.shake-big { animation:screenShake 0.4s ease-out; }
        #game-wrapper.shake-mega { animation:megaShake 0.6s ease-out; }
        @keyframes winGlow { from{transform:scale(1);} to{transform:scale(1.04);} }
        /* Win coin particles */
        .win-coin { position:absolute; width:8px; height:8px; border-radius:50%; pointer-events:none; z-index:31; animation:coinBurst 1s ease-out forwards; }
        @keyframes coinBurst { 0%{opacity:1;transform:translate(0,0) scale(1);} 100%{opacity:0;transform:translate(var(--cx),var(--cy)) scale(0);} }

        /* ‚ïê‚ïê‚ïê SCATTER ANTICIPATION ‚ïê‚ïê‚ïê */
        @keyframes anticipationPulse {
            0%,100% { box-shadow:inset 0 0 30px rgba(255,230,0,0.05); }
            50% { box-shadow:inset 0 0 60px rgba(255,230,0,0.15), 0 0 40px rgba(255,230,0,0.1); }
        }
        #game-wrapper.anticipation-pulse { animation:anticipationPulse 0.7s ease-in-out infinite; }

        /* ‚ïê‚ïê‚ïê FREE SPINS INTRO ‚ïê‚ïê‚ïê */
        #freespin-intro-overlay {
            position:absolute; inset:0; z-index:55; display:none; align-items:center; justify-content:center;
            background:rgba(3,3,12,0.95); backdrop-filter:blur(16px);
        }
        #freespin-intro-overlay.active { display:flex; }
        #freespin-intro-content { text-align:center; }
        #freespin-intro-title {
            font-family:'Orbitron',monospace; font-size:36px; font-weight:900; letter-spacing:12px;
            background:linear-gradient(135deg,var(--neon-yellow),var(--neon-green));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
            filter:drop-shadow(0 0 30px rgba(255,230,0,0.6));
            animation:fsBounce 0.8s cubic-bezier(0.175,0.885,0.32,1.4) both;
        }
        #freespin-intro-count {
            font-family:'Orbitron',monospace; font-size:72px; font-weight:900;
            color:var(--neon-yellow); text-shadow:0 0 40px rgba(255,230,0,0.7);
            animation:fsBounce 0.8s cubic-bezier(0.175,0.885,0.32,1.4) 0.3s both;
        }
        #freespin-intro-mult {
            font-family:'Orbitron',monospace; font-size:24px; font-weight:700; letter-spacing:6px;
            color:var(--neon-green); text-shadow:0 0 20px rgba(0,255,136,0.5);
            animation:fsBounce 0.8s cubic-bezier(0.175,0.885,0.32,1.4) 0.5s both;
        }
        #freespin-intro-sub {
            font-family:'Share Tech Mono',monospace; font-size:14px; letter-spacing:6px;
            color:var(--text-dim); margin-top:16px;
            animation:bonusFadeIn 0.8s ease-out 0.7s both;
        }
        @keyframes fsBounce { from{opacity:0;transform:scale(0.3);} to{opacity:1;transform:scale(1);} }

        /* ‚ïê‚ïê‚ïê FREE SPINS HUD ‚ïê‚ïê‚ïê */
        #freespin-hud {
            position:absolute; top:0; left:0; right:0; z-index:35;
            display:none; align-items:center; justify-content:center; gap:32px;
            padding:10px 20px;
            background:linear-gradient(180deg, rgba(255,230,0,0.12) 0%, rgba(0,0,0,0.85) 100%);
            border-bottom:2px solid rgba(255,230,0,0.5);
            box-shadow:0 4px 30px rgba(255,230,0,0.15);
            backdrop-filter:blur(12px);
        }
        #freespin-hud.active { display:flex; }
        .fs-hud-title {
            font-family:'Orbitron',monospace; font-size:14px; font-weight:900; letter-spacing:6px;
            background:linear-gradient(135deg,var(--neon-yellow),var(--neon-green));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
            filter:drop-shadow(0 0 8px rgba(255,230,0,0.5));
            animation:fsPulseText 1.5s ease-in-out infinite alternate;
        }
        @keyframes fsPulseText { from{filter:drop-shadow(0 0 8px rgba(255,230,0,0.5));} to{filter:drop-shadow(0 0 16px rgba(255,230,0,0.8));} }
        .fs-hud-item { text-align:center; }
        .fs-hud-label { font-family:'Share Tech Mono',monospace; font-size:9px; letter-spacing:2px; color:var(--text-dim); }
        .fs-hud-value { font-family:'Orbitron',monospace; font-size:22px; font-weight:700; color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,230,0,0.5); }
        #fs-remaining { font-size:28px; }
        .fs-hud-sep { width:1px; height:32px; background:rgba(255,230,0,0.25); }
        /* Spin counter: "3 of 10" style */
        .fs-counter { font-family:'Orbitron',monospace; font-size:11px; font-weight:600; color:rgba(255,230,0,0.6); letter-spacing:1px; margin-top:2px; }
        /* Game border glow during free spins */
        #canvas-container.freespin-active { box-shadow:0 0 30px rgba(255,230,0,0.2), inset 0 0 30px rgba(255,230,0,0.05); border-color:rgba(255,230,0,0.4) !important; transition:box-shadow 0.5s, border-color 0.5s; }

        /* ‚ïê‚ïê‚ïê BONUS OVERLAY ‚ïê‚ïê‚ïê */
        #bonus-overlay {
            position:absolute; inset:0; z-index:50; display:none; flex-direction:column; align-items:center; justify-content:flex-start;
            background:rgba(3,3,12,0.96); backdrop-filter:blur(12px); overflow-y:auto; padding:12px 0;
        }
        #bonus-overlay.active { display:flex; }
        #bonus-intro { text-align:center; animation:bonusFadeIn 0.6s ease-out; }
        @keyframes bonusFadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        #bonus-intro h2 { font-family:'Orbitron',monospace; font-size:22px; font-weight:900; letter-spacing:8px; background:linear-gradient(135deg,var(--neon-cyan),var(--neon-magenta)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter:drop-shadow(0 0 20px rgba(0,240,255,0.5)); margin-bottom:2px; }
        #bonus-intro p { font-family:'Share Tech Mono',monospace; font-size:11px; letter-spacing:2px; color:var(--text-dim); margin-bottom:10px; }

        #bonus-stats { display:flex; gap:40px; margin-bottom:10px; animation:bonusFadeIn 0.6s ease-out 0.2s both; }
        .bonus-stat { text-align:center; }
        .bonus-stat-label { font-family:'Share Tech Mono',monospace; font-size:9px; letter-spacing:2px; color:var(--text-dim); margin-bottom:2px; }
        .bonus-stat-value { font-family:'Orbitron',monospace; font-size:20px; font-weight:700; color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,230,0,0.4); }
        #bonus-picks-left { color:var(--neon-cyan); text-shadow:0 0 12px rgba(0,240,255,0.4); }

        #bonus-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; padding:0 30px; animation:bonusFadeIn 0.8s ease-out 0.3s both; }
        .bonus-cell {
            aspect-ratio:1.35; border:1px solid rgba(0,240,255,0.2); border-radius:10px;
            background:rgba(0,240,255,0.03); cursor:pointer; display:flex; flex-direction:column;
            align-items:center; justify-content:center; transition:all 0.2s; position:relative; overflow:hidden; min-width:100px;
        }
        .bonus-cell::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(0,240,255,0.05),transparent,rgba(180,0,255,0.05)); opacity:0; transition:opacity 0.2s; }
        .bonus-cell:hover:not(.revealed):not(.locked) { border-color:var(--neon-cyan); box-shadow:0 0 20px rgba(0,240,255,0.15),inset 0 0 20px rgba(0,240,255,0.05); transform:translateY(-2px); }
        .bonus-cell:hover:not(.revealed):not(.locked)::before { opacity:1; }
        .bonus-cell .cell-icon { font-size:26px; margin-bottom:2px; display:flex; align-items:center; justify-content:center; color:var(--neon-cyan); text-shadow:0 0 10px rgba(0,240,255,0.4); transition:all 0.3s; }
        .bonus-cell .cell-label { font-family:'Share Tech Mono',monospace; font-size:9px; letter-spacing:1.5px; color:var(--text-dim); transition:all 0.3s; }

        .bonus-cell.revealed { cursor:default; animation:cellReveal 0.5s ease-out; }
        .bonus-cell.revealed.prize-low { border-color:rgba(0,240,255,0.4); background:rgba(0,240,255,0.06); }
        .bonus-cell.revealed.prize-mid { border-color:rgba(0,255,136,0.5); background:rgba(0,255,136,0.06); }
        .bonus-cell.revealed.prize-high { border-color:rgba(255,230,0,0.5); background:rgba(255,230,0,0.08); box-shadow:0 0 20px rgba(255,230,0,0.15); }
        .bonus-cell.revealed.prize-mega { border-color:rgba(255,0,170,0.6); background:rgba(255,0,170,0.08); box-shadow:0 0 30px rgba(255,0,170,0.2); }
        .bonus-cell.revealed .cell-value { font-family:'Orbitron',monospace; font-size:15px; font-weight:800; }
        .bonus-cell.revealed.prize-low .cell-value { color:var(--neon-cyan); }
        .bonus-cell.revealed.prize-mid .cell-value { color:var(--neon-green); }
        .bonus-cell.revealed.prize-high .cell-value { color:var(--neon-yellow); text-shadow:0 0 10px rgba(255,230,0,0.5); }
        .bonus-cell.revealed.prize-mega .cell-value { color:var(--neon-magenta); text-shadow:0 0 14px rgba(255,0,170,0.6); }
        .bonus-cell.locked { cursor:default; opacity:0.3; border-color:rgba(255,255,255,0.05); }
        @keyframes cellReveal { 0%{transform:scale(0.8) rotateY(90deg);opacity:0.5} 50%{transform:scale(1.1) rotateY(0deg);opacity:1} 100%{transform:scale(1)} }

        #bonus-total-bar { margin-top:10px; text-align:center; opacity:0; transition:opacity 0.5s; }
        #bonus-total-bar.visible { opacity:1; }
        #bonus-total-label { font-family:'Share Tech Mono',monospace; font-size:10px; letter-spacing:3px; color:var(--text-dim); }
        #bonus-total-value { font-family:'Orbitron',monospace; font-size:28px; font-weight:900; color:var(--neon-yellow); text-shadow:0 0 20px rgba(255,230,0,0.5); }
        #bonus-collect-btn {
            display:none; margin-top:8px; margin-bottom:8px; font-family:'Orbitron',monospace; font-size:13px; font-weight:700; letter-spacing:4px;
            padding:10px 36px; border:2px solid var(--neon-yellow); border-radius:8px; background:rgba(255,230,0,0.08);
            color:var(--neon-yellow); cursor:pointer; transition:all 0.2s; text-shadow:0 0 10px rgba(255,230,0,0.4); animation:bonusFadeIn 0.5s ease-out;
        }
        #bonus-collect-btn:hover { background:rgba(255,230,0,0.15); box-shadow:0 0 30px rgba(255,230,0,0.2); transform:scale(1.04); }

        /* ‚ïê‚ïê‚ïê Controls ‚ïê‚ïê‚ïê */
        #controls {
            position:relative;
            display:flex; align-items:center; justify-content:space-between; padding:12px 16px;
            background:var(--bg-panel); border-radius:14px;
            backdrop-filter:blur(20px); margin-top:8px;
            box-shadow:0 8px 32px rgba(0,0,0,0.4),inset 0 1px 0 var(--glass-shine);
            border:none;
        }
        #spin-btn-wrap { position:absolute; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; margin-top:-60px; z-index:10; }
        .ctrl-group { display:flex; flex-direction:column; align-items:center; gap:2px; min-width:110px; flex:1; }
        .ctrl-label { font-family:'Share Tech Mono',monospace; font-size:9px; letter-spacing:2.5px; text-transform:uppercase; color:var(--text-dim); }
        .ctrl-value { font-family:'Orbitron',monospace; font-size:18px; font-weight:700; color:var(--text-primary); }
        .ctrl-value.win-active { color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,230,0,0.5); }
        .bet-row { display:flex; align-items:center; gap:10px; }
        .bet-btn { width:32px; height:32px; border-radius:8px; border:1px solid rgba(0,240,255,0.25); background:rgba(0,240,255,0.06); color:var(--neon-cyan); font-family:'Orbitron',monospace; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.15s; display:flex; align-items:center; justify-content:center; }
        .bet-btn:hover { background:rgba(0,240,255,0.15); border-color:rgba(0,240,255,0.5); box-shadow:0 0 12px rgba(0,240,255,0.2); }

        #spin-btn { position:relative; display:flex; align-items:center; justify-content:center; width:140px; height:140px; border-radius:50%; border:none; background-color:#000; background-size:contain; background-repeat:no-repeat; background-position:center; cursor:pointer; transition:all 0.3s; overflow:visible; filter:drop-shadow(0 0 15px rgba(255,0,170,0.4)) drop-shadow(0 0 30px rgba(255,0,170,0.2)); animation:spinPulse 2s ease-in-out infinite; }
        #spin-btn.spinning { filter:drop-shadow(0 0 15px rgba(0,240,255,0.4)) drop-shadow(0 0 30px rgba(0,240,255,0.2)); }
        @keyframes spinPulse { 0%,100%{ filter:drop-shadow(0 0 15px rgba(255,0,170,0.4)) drop-shadow(0 0 30px rgba(255,0,170,0.2)); } 50%{ filter:drop-shadow(0 0 25px rgba(255,0,170,0.6)) drop-shadow(0 0 50px rgba(255,0,170,0.3)) drop-shadow(0 0 80px rgba(255,0,170,0.15)); } }
        #spin-btn::after { content:''; position:absolute; inset:-3px; border-radius:50%; background:conic-gradient(from 0deg,transparent 0%,var(--neon-cyan) 25%,transparent 50%); opacity:0; }
        #spin-btn:hover:not(:disabled) { transform:scale(1.08); filter:drop-shadow(0 0 30px rgba(0,240,255,0.6)) drop-shadow(0 0 60px rgba(255,0,170,0.3)); animation:none; }
        #spin-btn:active:not(:disabled) { transform:scale(0.95); }
        #spin-btn:disabled { cursor:not-allowed; animation:none; opacity:1; filter:brightness(0.4); }
        #spin-btn.spinning, #spin-btn:disabled.spinning { animation:spinGlowRotate 0.8s linear infinite; filter:grayscale(1); }
        #spin-btn.spinning::after { opacity:0.6; animation:spinGlow 1s linear infinite; }
        @keyframes spinGlow { to{transform:rotate(360deg)} }
        @keyframes spinGlowRotate { 0%,100%{ filter:grayscale(1); } 50%{ filter:grayscale(1); } }

        /* Spin button sparkle */
        .sparkle-dot {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 60;
            animation: sparkleFly 0.7s ease-out forwards;
        }
        @keyframes sparkleFly {
            0% { transform: translate(0,0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
        }
        #spin-btn.sparkle-ring {
            animation: btnFlash 0.5s ease-out;
        }
        @keyframes btnFlash {
            0% { box-shadow: 0 0 0 0 rgba(0,240,255,0.6); }
            50% { box-shadow: 0 0 30px 8px rgba(0,240,255,0.3), 0 0 60px 16px rgba(0,240,255,0.1); }
            100% { box-shadow: none; }
        }

        /* ‚ïê‚ïê‚ïê SPIN MENU POPUP ‚ïê‚ïê‚ïê */
        #spin-menu-toggle {
            position:absolute; bottom:2px; right:2px; width:24px; height:24px; border-radius:50%;
            border:1px solid rgba(0,240,255,0.3); background:rgba(0,240,255,0.08);
            color:var(--neon-cyan); font-size:12px; font-weight:700; cursor:pointer;
            display:flex; align-items:center; justify-content:center; z-index:11;
            transition:all 0.2s; font-family:'Orbitron',monospace;
        }
        #spin-menu-toggle:hover { border-color:var(--neon-cyan); background:rgba(0,240,255,0.15); box-shadow:0 0 10px rgba(0,240,255,0.2); }
        #spin-menu-toggle.open { background:rgba(0,240,255,0.2); border-color:var(--neon-cyan); }
        #spin-menu {
            position:absolute; bottom:calc(100% + 12px); left:50%; transform:translateX(-50%) scale(0.9);
            display:none; flex-direction:column; gap:6px; padding:10px;
            background:rgba(5,5,20,0.95); border:1px solid rgba(0,240,255,0.25);
            border-radius:10px; backdrop-filter:blur(16px); z-index:12;
            box-shadow:0 8px 30px rgba(0,0,0,0.6), 0 0 20px rgba(0,240,255,0.08);
            opacity:0; transition:opacity 0.2s, transform 0.2s;
            min-width:120px;
        }
        #spin-menu.open { display:flex; opacity:1; transform:translateX(-50%) scale(1); }
        #spin-menu::after {
            content:''; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%) rotate(45deg);
            width:10px; height:10px; background:rgba(5,5,20,0.95);
            border-right:1px solid rgba(0,240,255,0.25); border-bottom:1px solid rgba(0,240,255,0.25);
        }
        .menu-btn {
            font-family:'Share Tech Mono',monospace; font-size:11px; letter-spacing:1.5px;
            text-transform:uppercase; padding:8px 16px; border-radius:6px;
            border:1px solid rgba(0,240,255,0.15); background:rgba(0,240,255,0.04);
            color:var(--text-dim); cursor:pointer; transition:all 0.15s; white-space:nowrap;
            text-align:center;
        }
        .menu-btn:hover { border-color:rgba(0,240,255,0.4); color:var(--neon-cyan); }
        .menu-btn.active { border-color:var(--neon-magenta); color:var(--neon-magenta); background:rgba(255,0,170,0.08); box-shadow:0 0 12px rgba(255,0,170,0.15); }
        .menu-btn.speed-btn.active { border-color:var(--neon-yellow); color:var(--neon-yellow); background:rgba(255,230,0,0.08); box-shadow:0 0 12px rgba(255,230,0,0.2); }
        .menu-btn.speed-btn.active.sturbo { border-color:var(--neon-green); color:var(--neon-green); background:rgba(0,255,136,0.08); box-shadow:0 0 16px rgba(0,255,136,0.25); }
        .menu-sep { height:1px; background:linear-gradient(90deg,transparent,rgba(0,240,255,0.15),transparent); }

        /* ‚ïê‚ïê‚ïê AUTO SPIN PICKER ‚ïê‚ïê‚ïê */
        #auto-picker {
            display:none; flex-direction:column; gap:4px; padding:8px;
            background:rgba(5,5,20,0.97); border:1px solid rgba(0,240,255,0.25);
            border-radius:10px; backdrop-filter:blur(16px);
            box-shadow:0 8px 30px rgba(0,0,0,0.6), 0 0 20px rgba(0,240,255,0.08);
            min-width:130px;
        }
        #auto-picker.open { display:flex; }
        .auto-picker-title {
            font-family:'Share Tech Mono',monospace; font-size:9px; letter-spacing:2px;
            color:var(--text-dim); text-align:center; padding:2px 0 4px;
        }
        .auto-pick-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px; }
        .auto-pick-btn {
            font-family:'Orbitron',monospace; font-size:11px; font-weight:600;
            padding:7px 6px; border-radius:6px;
            border:1px solid rgba(0,240,255,0.15); background:rgba(0,240,255,0.04);
            color:var(--text-dim); cursor:pointer; transition:all 0.15s;
            text-align:center; white-space:nowrap;
        }
        .auto-pick-btn:hover { border-color:rgba(255,0,170,0.5); color:var(--neon-magenta); background:rgba(255,0,170,0.08); box-shadow:0 0 10px rgba(255,0,170,0.15); }
        .auto-pick-btn.wide { grid-column:span 2; }

        /* ‚ïê‚ïê‚ïê AUTO SPIN HUD ‚ïê‚ïê‚ïê */
        #auto-hud {
            display:none; position:absolute; top:-28px; left:50%; transform:translateX(-50%);
            flex-direction:row; align-items:center; gap:8px;
            background:rgba(5,5,20,0.92); border:1px solid rgba(255,0,170,0.35);
            border-radius:20px; padding:4px 10px 4px 14px;
            box-shadow:0 0 16px rgba(255,0,170,0.15);
            z-index:13; white-space:nowrap;
        }
        #auto-hud.show { display:flex; }
        #auto-remaining {
            font-family:'Orbitron',monospace; font-size:12px; font-weight:700;
            color:var(--neon-magenta); text-shadow:0 0 8px rgba(255,0,170,0.4);
            letter-spacing:1px;
        }
        #auto-stop-btn {
            font-family:'Share Tech Mono',monospace; font-size:9px; letter-spacing:1.5px;
            padding:3px 10px; border-radius:10px;
            border:1px solid rgba(255,0,170,0.4); background:rgba(255,0,170,0.1);
            color:var(--neon-magenta); cursor:pointer; transition:all 0.15s;
        }
        #auto-stop-btn:hover { background:rgba(255,0,170,0.25); border-color:var(--neon-magenta); box-shadow:0 0 12px rgba(255,0,170,0.3); }

        #btn-mute-top {
            position:absolute; top:8px; right:8px; z-index:30;
            width:32px; height:32px; border-radius:8px;
            border:1px solid rgba(0,240,255,0.15); background:rgba(0,240,255,0.04);
            color:var(--text-dim); font-size:14px; cursor:pointer; transition:all 0.15s;
            display:flex; align-items:center; justify-content:center;
        }
        #btn-mute-top:hover { border-color:rgba(0,240,255,0.4); color:var(--neon-cyan); }
        #btn-mute-top.active { border-color:var(--neon-magenta); color:var(--neon-magenta); background:rgba(255,0,170,0.08); }

        /* ‚ïê‚ïê‚ïê Buy Bonus Button ‚ïê‚ïê‚ïê */
        #buy-bonus-btn {
            position:absolute; right:-80px; top:50%; transform:translateY(-50%);
            width:60px; height:60px; border-radius:12px;
            border:2px solid var(--neon-magenta);
            background:rgba(255,0,170,0.08);
            color:var(--neon-magenta);
            font-family:'Orbitron',monospace; font-size:8px; font-weight:700;
            letter-spacing:1px; cursor:pointer;
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
            transition:all 0.3s;
            box-shadow:0 0 15px rgba(255,0,170,0.2), inset 0 0 15px rgba(255,0,170,0.05);
            text-shadow:0 0 8px rgba(255,0,170,0.5);
            z-index:10;
        }
        #buy-bonus-btn .bb-icon { font-size:18px; filter:drop-shadow(0 0 4px rgba(255,0,170,0.5)); }
        #buy-bonus-btn:hover {
            background:rgba(255,0,170,0.15); border-color:#ff44cc;
            box-shadow:0 0 25px rgba(255,0,170,0.4), 0 0 50px rgba(255,0,170,0.15), inset 0 0 20px rgba(255,0,170,0.08);
            transform:translateY(-50%) scale(1.08);
        }
        #buy-bonus-btn:active { transform:translateY(-50%) scale(0.95); }
        #buy-bonus-btn:disabled { opacity:0.3; cursor:not-allowed; filter:grayscale(0.5); }
        #buy-bonus-btn:disabled:hover { transform:translateY(-50%) scale(1); box-shadow:0 0 15px rgba(255,0,170,0.2), inset 0 0 15px rgba(255,0,170,0.05); background:rgba(255,0,170,0.08); }

        /* ‚ïê‚ïê‚ïê Buy Bonus Popup ‚ïê‚ïê‚ïê */
        #buy-bonus-overlay {
            position:fixed; inset:0; z-index:10000;
            background:rgba(2,2,10,0.85); backdrop-filter:blur(12px);
            display:none; align-items:center; justify-content:center;
            opacity:0; transition:opacity 0.3s;
        }
        #buy-bonus-overlay.active { display:flex; opacity:1; }
        #buy-bonus-popup {
            position:relative;
            background:linear-gradient(160deg, rgba(10,10,30,0.98), rgba(5,5,15,0.98));
            border:1px solid rgba(255,0,170,0.25);
            border-radius:18px; padding:32px 28px 28px;
            max-width:540px; width:90%;
            box-shadow:0 0 60px rgba(255,0,170,0.15), 0 0 120px rgba(180,0,255,0.08), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        #buy-bonus-popup h2 {
            text-align:center; font-family:'Orbitron',monospace; font-size:16px;
            font-weight:800; letter-spacing:5px; color:var(--neon-magenta);
            text-shadow:0 0 20px rgba(255,0,170,0.5); margin-bottom:24px;
        }
        #bb-close {
            position:absolute; top:12px; right:14px;
            width:30px; height:30px; border-radius:50%;
            border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.04);
            color:var(--text-dim); font-size:16px; cursor:pointer;
            display:flex; align-items:center; justify-content:center;
            transition:all 0.2s; font-family:'Rajdhani',sans-serif;
        }
        #bb-close:hover { border-color:var(--neon-cyan); color:var(--neon-cyan); background:rgba(0,240,255,0.08); box-shadow:0 0 12px rgba(0,240,255,0.2); }
        .bb-cards { display:flex; gap:16px; justify-content:center; }
        .bb-card {
            flex:1; max-width:240px;
            background:rgba(255,0,170,0.03);
            border:1.5px solid rgba(255,0,170,0.2);
            border-radius:14px; padding:20px 16px;
            display:flex; flex-direction:column; align-items:center; gap:10px;
            transition:all 0.3s; cursor:default;
            box-shadow:0 0 20px rgba(255,0,170,0.06);
            position:relative; overflow:hidden;
        }
        .bb-card::before {
            content:''; position:absolute; inset:0;
            background:linear-gradient(180deg, rgba(255,0,170,0.04) 0%, transparent 40%);
            pointer-events:none;
        }
        .bb-card:hover {
            border-color:rgba(255,0,170,0.45);
            box-shadow:0 0 30px rgba(255,0,170,0.15), 0 0 60px rgba(255,0,170,0.06);
            transform:scale(1.03);
        }
        .bb-card-icon { font-size:32px; filter:drop-shadow(0 0 8px rgba(255,0,170,0.4)); }
        .bb-card-title {
            font-family:'Orbitron',monospace; font-size:11px; font-weight:700;
            letter-spacing:2px; color:var(--neon-magenta);
            text-shadow:0 0 10px rgba(255,0,170,0.4);
        }
        .bb-card-desc {
            font-size:12px; color:var(--text-dim); text-align:center;
            line-height:1.4; letter-spacing:0.3px;
        }
        .bb-card-cost {
            font-family:'Orbitron',monospace; font-size:18px; font-weight:800;
            color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,230,0,0.4);
            margin:4px 0;
        }
        .bb-card-mult {
            font-family:'Share Tech Mono',monospace; font-size:10px;
            color:var(--text-dim); letter-spacing:1.5px;
        }
        .bb-buy-btn {
            width:100%; padding:10px 0; border-radius:8px;
            border:1.5px solid var(--neon-magenta);
            background:rgba(255,0,170,0.1);
            color:var(--neon-magenta);
            font-family:'Orbitron',monospace; font-size:11px; font-weight:700;
            letter-spacing:3px; cursor:pointer;
            transition:all 0.2s; margin-top:4px;
            text-shadow:0 0 6px rgba(255,0,170,0.3);
        }
        .bb-buy-btn:hover {
            background:rgba(255,0,170,0.2); border-color:#ff44cc;
            box-shadow:0 0 20px rgba(255,0,170,0.3);
            text-shadow:0 0 12px rgba(255,0,170,0.5);
        }
        .bb-buy-btn:active { transform:scale(0.96); }
        .bb-buy-btn:disabled { opacity:0.3; cursor:not-allowed; }
        .bb-buy-btn:disabled:hover { background:rgba(255,0,170,0.1); border-color:var(--neon-magenta); box-shadow:none; transform:none; }
        .bb-card.cyan { border-color:rgba(0,240,255,0.2); background:rgba(0,240,255,0.03); box-shadow:0 0 20px rgba(0,240,255,0.06); }
        .bb-card.cyan::before { background:linear-gradient(180deg, rgba(0,240,255,0.04) 0%, transparent 40%); }
        .bb-card.cyan:hover { border-color:rgba(0,240,255,0.45); box-shadow:0 0 30px rgba(0,240,255,0.15), 0 0 60px rgba(0,240,255,0.06); }
        .bb-card.cyan .bb-card-title { color:var(--neon-cyan); text-shadow:0 0 10px rgba(0,240,255,0.4); }
        .bb-card.cyan .bb-buy-btn { border-color:var(--neon-cyan); color:var(--neon-cyan); background:rgba(0,240,255,0.1); text-shadow:0 0 6px rgba(0,240,255,0.3); }
        .bb-card.cyan .bb-buy-btn:hover { background:rgba(0,240,255,0.2); border-color:#44eeff; box-shadow:0 0 20px rgba(0,240,255,0.3); }
        .bb-card.cyan .bb-buy-btn:disabled { opacity:0.3; }
        .bb-card.cyan .bb-buy-btn:disabled:hover { background:rgba(0,240,255,0.1); border-color:var(--neon-cyan); box-shadow:none; transform:none; }

        /* ‚ïê‚ïê‚ïê Responsive ‚ïê‚ïê‚ïê */
        @media(max-width:920px){
            #game-wrapper { width:100%; }
        }
        @media(max-width:700px){
            #game-header { padding:10px 0 4px; }
            #game-title { height:36px; }
            #controls { flex-wrap:wrap; gap:8px; padding:10px 12px; justify-content:center; }
            .ctrl-group { min-width:80px; }
            .ctrl-value { font-size:14px; }
            .ctrl-label { font-size:8px; }
            #spin-btn { width:110px; height:110px; }
            #spin-btn-wrap { margin-top:-45px; }
            #buy-bonus-btn { right:-65px; width:50px; height:50px; font-size:7px; }
            #buy-bonus-btn .bb-icon { font-size:14px; }
            .bet-btn { width:36px; height:36px; font-size:18px; }
            /* Bonus overlay */
            #bonus-overlay { padding:8px 0; }
            #bonus-intro h2 { font-size:16px; letter-spacing:4px; }
            #bonus-intro p { font-size:10px; margin-bottom:8px; }
            #bonus-grid { grid-template-columns:repeat(3,1fr); padding:0 12px; gap:6px; }
            .bonus-cell { min-width:0; aspect-ratio:1.2; }
            .bonus-cell .cell-icon img { width:32px !important; }
            #bonus-total-value { font-size:24px; }
            #bonus-collect-btn { font-size:11px; padding:10px 28px; letter-spacing:3px; }
            /* Vault meter */
            #bonus-meter-wrap { margin:0 8px; }
        }
        @media(max-width:480px){
            #game-header { padding:6px 0 2px; }
            #game-title { height:28px; }
            #controls { padding:8px 8px; gap:6px; }
            .ctrl-group { min-width:65px; }
            .ctrl-value { font-size:12px; }
            #spin-btn { width:90px; height:90px; }
            #spin-btn-wrap { margin-top:-35px; }
            #buy-bonus-btn { right:-52px; width:42px; height:42px; font-size:6px; border-radius:8px; }
            #buy-bonus-btn .bb-icon { font-size:12px; }
            .bb-cards { flex-direction:column; align-items:center; }
            .bb-card { max-width:100%; }
            #buy-bonus-popup { padding:24px 16px 20px; }
            #buy-bonus-popup h2 { font-size:13px; letter-spacing:3px; margin-bottom:16px; }
            .bet-btn { width:32px; height:32px; font-size:16px; }
            #bonus-grid { grid-template-columns:repeat(3,1fr); padding:0 8px; gap:5px; }
            .bonus-cell .cell-icon img { width:26px !important; }
            .bonus-stat-value { font-size:16px; }
            #bonus-total-value { font-size:20px; }
            #bonus-collect-btn { font-size:10px; padding:8px 24px; }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-header">
        <img id="game-title" src="symbols/title.png" alt="NEON VAULT">
        <div class="header-line"></div>
    </div>

    <div id="info-strip">
        <div class="info-left">
            <div>LINES <span>20</span></div>
            <div>RTP <span>96.0%</span></div>
            <div>MAX <span>1000√ó</span></div>
            <div>SESSION <span id="info-rtp">‚Äî</span></div>
        </div>
        <div id="bonus-meter-wrap">
            <div id="bonus-meter-icon">üîê</div>
            <div id="bonus-meter-mid">
                <div id="bonus-meter-label">VAULT BREACH</div>
                <div id="bonus-meter-track">
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                    <div class="meter-segment"></div>
                </div>
            </div>
            <div id="bonus-meter-pct">0%</div>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="game-canvas"></canvas>
        <div id="win-overlay">
            <div class="win-label" id="win-label">WIN</div>
            <div class="win-amount" id="win-amount">$0.00</div>
            <div class="win-sub" id="win-sub"></div>
        </div>

        <button onclick="startBonus()" style="position:fixed;bottom:8px;left:8px;z-index:9999;padding:4px 10px;font-size:11px;font-family:'Share Tech Mono',monospace;background:rgba(255,0,170,0.15);border:1px solid rgba(255,0,170,0.4);color:#f0a;border-radius:4px;cursor:pointer;opacity:0.6;transition:opacity 0.2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">‚ö° BONUS</button>
        <div id="freespin-intro-overlay">
            <div id="freespin-intro-content">
                <div id="freespin-intro-title">FREE SPINS</div>
                <div id="freespin-intro-count"></div>
                <div id="freespin-intro-mult"></div>
                <div id="freespin-intro-sub">GOOD LUCK</div>
            </div>
        </div>
        <div id="freespin-hud">
            <div class="fs-hud-title">FREE SPINS</div>
            <div class="fs-hud-sep"></div>
            <div class="fs-hud-item"><div class="fs-hud-label">SPINS LEFT</div><div class="fs-hud-value" id="fs-remaining">0</div><div class="fs-counter" id="fs-counter">0 of 0</div></div>
            <div class="fs-hud-sep"></div>
            <div class="fs-hud-item"><div class="fs-hud-label">MULTIPLIER</div><div class="fs-hud-value" id="fs-multiplier">2x</div></div>
            <div class="fs-hud-sep"></div>
            <div class="fs-hud-item"><div class="fs-hud-label">TOTAL WON</div><div class="fs-hud-value" id="fs-total-win">$0.00</div></div>
        </div>
        <div id="bonus-overlay">
            <div id="bonus-intro">
                <h2>‚ö° HACK THE VAULT ‚ö°</h2>
                <p id="bonus-subtitle">PICK 5 CELLS TO CRACK THE ENCRYPTION</p>
            </div>
            <div id="bonus-stats">
                <div class="bonus-stat">
                    <div class="bonus-stat-label">PICKS LEFT</div>
                    <div class="bonus-stat-value" id="bonus-picks-left">5</div>
                </div>
                <div class="bonus-stat">
                    <div class="bonus-stat-label">TOTAL WON</div>
                    <div class="bonus-stat-value" id="bonus-running-total">$0.00</div>
                </div>
            </div>
            <div id="bonus-grid"></div>
            <div id="bonus-total-bar">
                <div id="bonus-total-label">VAULT BREACHED</div>
                <div id="bonus-total-value">$0.00</div>
            </div>
            <button id="bonus-collect-btn">COLLECT</button>
        </div>

    </div>

    <div id="controls">
        <div class="ctrl-group">
            <div class="ctrl-label">Balance</div>
            <div class="ctrl-value" id="ui-balance">1,000.00</div>
        </div>
        <div class="ctrl-group">
            <div class="ctrl-label">Bet</div>
            <div class="bet-row">
                <button class="bet-btn" id="bet-dn">‚àí</button>
                <div class="ctrl-value" id="ui-bet">1.00</div>
                <button class="bet-btn" id="bet-up">+</button>
            </div>
        </div>
        <div id="spin-btn-wrap"><div id="spin-menu"><button class="menu-btn" id="btn-auto">AUTO</button><div id="auto-picker"><div class="auto-picker-title">AUTO SPINS</div><div class="auto-pick-grid"><button class="auto-pick-btn" data-spins="10">10</button><button class="auto-pick-btn" data-spins="25">25</button><button class="auto-pick-btn" data-spins="50">50</button><button class="auto-pick-btn" data-spins="75">75</button><button class="auto-pick-btn" data-spins="100">100</button><button class="auto-pick-btn" data-spins="500">500</button><button class="auto-pick-btn wide" data-spins="1000">1000</button></div></div><div class="menu-sep"></div><button class="menu-btn speed-btn" id="btn-turbo">TURBO</button><button class="menu-btn speed-btn" id="btn-sturbo">S.TURBO</button><div class="menu-sep"></div><button class="menu-btn" id="btn-mute">üîä</button></div><div id="auto-hud"><span id="auto-remaining">0</span><button id="auto-stop-btn">STOP</button></div><button id="spin-menu-toggle">‚öô</button><button id="spin-btn" style="background-image:url(symbols/spin-btn.png)"></button><button id="buy-bonus-btn"><span class="bb-icon">&#x1F4A0;</span>BUY<br>BONUS</button></div>
        <div class="ctrl-group">
            <div class="ctrl-label">Win</div>
            <div class="ctrl-value" id="ui-win">0.00</div>
        </div>
    </div>
</div>

    <!-- Buy Bonus Popup -->
    <div id="buy-bonus-overlay">
        <div id="buy-bonus-popup">
            <button id="bb-close">&times;</button>
            <h2>BUY BONUS</h2>
            <div class="bb-cards">
                <div class="bb-card cyan">
                    <div class="bb-card-icon">&#x26A1;</div>
                    <div class="bb-card-title">ENHANCED SPIN</div>
                    <div class="bb-card-desc">Next spin has boosted Scatter &amp; Wild frequency for bigger wins</div>
                    <div class="bb-card-cost" id="bb-enhanced-cost">$2.00</div>
                    <div class="bb-card-mult">2&times; CURRENT BET</div>
                    <button class="bb-buy-btn" id="bb-buy-enhanced">BUY</button>
                </div>
                <div class="bb-card">
                    <div class="bb-card-icon">&#x1F525;</div>
                    <div class="bb-card-title">10 FREE SPINS</div>
                    <div class="bb-card-desc">Instantly trigger 10 Free Spins with a 3&times; multiplier</div>
                    <div class="bb-card-cost" id="bb-freespin-cost">$100.00</div>
                    <div class="bb-card-mult">100&times; CURRENT BET</div>
                    <button class="bb-buy-btn" id="bb-buy-freespins">BUY</button>
                </div>
            </div>
        </div>
    </div>

<script>
const W=900,H=500,REELS=5,ROWS=3,SYM_W=140,SYM_H=130,REEL_GAP=8;
const GRID_W=REELS*SYM_W+(REELS-1)*REEL_GAP, GRID_H=ROWS*SYM_H;
const GRID_X=(W-GRID_W)/2, GRID_Y=(H-GRID_H)/2;
const CYAN=0x00f0ff,MAGENTA=0xff00aa,PURPLE=0xb400ff,YELLOW=0xffe600,GREEN=0x00ff88;

const app=new PIXI.Application({view:document.getElementById('game-canvas'),width:W,height:H,backgroundColor:0x06060f,antialias:true,resolution:Math.min(devicePixelRatio||1,2),autoDensity:true});

const SYMS={
    W:{glyph:'‚óà',label:'WILD',colors:[CYAN,MAGENTA],tier:'wild'},
    S:{glyph:'‚¨°',label:'SCATTER',colors:[YELLOW,GREEN],tier:'scatter'},
    H1:{glyph:'‚óÜ',label:'DIAMOND',colors:[0x00bfff,CYAN],tier:'high'},
    H2:{glyph:'‚óè',label:'RUBY',colors:[0xff2255,MAGENTA],tier:'high'},
    H3:{glyph:'‚ñ≤',label:'EMERALD',colors:[GREEN,0x00cc66],tier:'high'},
    L1:{glyph:'A',label:'ACE',colors:[0x8888cc,0x6666aa],tier:'low'},
    L2:{glyph:'K',label:'KING',colors:[0x7788bb,0x5566aa],tier:'low'},
    L3:{glyph:'Q',label:'QUEEN',colors:[0x8877aa,0x665599],tier:'low'},
    L4:{glyph:'J',label:'JACK',colors:[0x667799,0x445577],tier:'low'},
};

const STRIPS=[
    ["L4","L3","L2","L3","L4","L1","H1","H1","W","L2","L1","W","L4","H1","L2","H1","L1","L3","H1","L2","L3","L4","L1","H2","L2","S","H3","H1","L1","L2"],
    ["L2","L3","H3","L1","H3","H3","L2","L4","L3","L1","L4","L4","L2","H1","L1","H2","H2","W","L2","H2","L1","W","H3","L2","L3","L1","S","L4","L3","L2"],
    ["L3","L1","L4","L2","H1","H1","L1","H3","L3","L2","L3","L1","H1","H3","L2","W","H1","L1","L4","L2","H2","L3","H3","L1","L2","L3","S","H2","L1","L2"],
    ["L1","L2","L4","H3","L3","L1","L2","L4","H2","W","L1","H3","H1","L2","H2","L1","L4","W","L2","L3","L1","H3","L3","L2","H2","H1","S","L1","L2","L4"],
    ["L4","L1","L2","H2","H3","H1","L1","L3","H2","L2","L4","L1","H1","L4","L2","H1","W","L1","L4","L2","L4","H2","L1","H1","L2","S","H1","L1","L4","L2"],
];

const PAYLINES=[[1,1,1,1,1],[0,0,0,0,0],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2],[0,0,1,2,2],[2,2,1,0,0],[1,0,0,0,1],[1,2,2,2,1],[0,1,1,1,0],[2,1,1,1,2],[1,0,1,0,1],[1,2,1,2,1],[0,1,0,1,0],[2,1,2,1,2],[1,1,0,1,1],[1,1,2,1,1],[0,0,1,0,0],[2,2,1,2,2],[0,2,0,2,0]];
const PAYTABLE={W:{3:50,4:200,5:1000},H1:{3:30,4:100,5:500},H2:{3:20,4:75,5:250},H3:{3:15,4:50,5:150},L1:{3:10,4:30,5:100},L2:{3:8,4:25,5:75},L3:{3:5,4:20,5:50},L4:{3:3,4:15,5:30}};
const SCATTER_PAYS={3:5,4:20,5:100};

// ‚îÄ‚îÄ‚îÄ Audio Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SFX=(()=>{
    let ctx=null,masterGain=null,musicGain=null,muted=false;
    function init(){
        if(ctx)return;
        ctx=new(window.AudioContext||window.webkitAudioContext)();
        masterGain=ctx.createGain();masterGain.gain.value=1.0;masterGain.connect(ctx.destination);
        musicGain=ctx.createGain();musicGain.gain.value=0.18;musicGain.connect(masterGain);
    }
    function ensure(){if(!ctx)init();if(ctx.state==='suspended')ctx.resume();}
    function tone(freq,type,dur,vol=0.3,delay=0){
        ensure();const t=ctx.currentTime+delay;
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type=type;o.frequency.setValueAtTime(freq,t);
        g.gain.setValueAtTime(vol,t);g.gain.exponentialRampToValueAtTime(0.001,t+dur);
        o.connect(g);g.connect(masterGain);o.start(t);o.stop(t+dur);
    }
    function noise(dur,vol=0.1,delay=0){
        ensure();const t=ctx.currentTime+delay;
        const buf=ctx.createBuffer(1,ctx.sampleRate*dur,ctx.sampleRate);
        const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);
        const s=ctx.createBufferSource(),g=ctx.createGain(),f=ctx.createBiquadFilter();
        s.buffer=buf;f.type='highpass';f.frequency.value=3000;
        g.gain.setValueAtTime(vol,t);g.gain.exponentialRampToValueAtTime(0.001,t+dur);
        s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);s.stop(t+dur);
    }
    return{
        init:ensure,
        toggleMute(){muted=!muted;if(masterGain)masterGain.gain.value=muted?0:0.5;return muted;},
        get muted(){return muted;},
        // Spin start: whoosh + electronic click
        spinStart(){
            ensure();
            noise(0.25,0.08);
            tone(800,'sine',0.06,0.15);
            tone(400,'sine',0.08,0.1,0.03);
        },
        // Each reel stopping: thud + click
        reelStop(idx){
            ensure();
            tone(120-idx*15,'sine',0.12,0.2);
            tone(60,'triangle',0.08,0.15);
            noise(0.06,0.06);
        },
        // Small win
        winSmall(){
            ensure();
            [523,659,784].forEach((f,i)=>tone(f,'sine',0.15,0.2,i*0.08));
            noise(0.04,0.03);
        },
        // Big win: ascending arpeggio
        winBig(){
            ensure();
            [523,659,784,1047,1319].forEach((f,i)=>{
                tone(f,'sine',0.25,0.25,i*0.1);
                tone(f*1.005,'triangle',0.2,0.1,i*0.1);
            });
            noise(0.08,0.05,0.5);
        },
        // Mega win: epic fanfare
        winMega(){
            ensure();
            const notes=[523,659,784,1047,1319,1568];
            notes.forEach((f,i)=>{
                tone(f,'sine',0.4,0.3,i*0.12);
                tone(f*0.5,'triangle',0.35,0.15,i*0.12);
                tone(f*2,'sine',0.2,0.08,i*0.12+0.05);
            });
            // Shimmer
            for(let i=0;i<8;i++)tone(2000+Math.random()*2000,'sine',0.15,0.04,0.7+i*0.06);
        },
        // Scatter land
        scatterLand(){
            ensure();
            tone(880,'sine',0.2,0.25);
            tone(1108,'sine',0.2,0.2,0.1);
            tone(1318,'sine',0.3,0.25,0.2);
            noise(0.1,0.04,0.1);
        },
        // Bonus trigger: alarm-style
        bonusTrigger(){
            ensure();
            for(let i=0;i<3;i++){
                tone(880,'square',0.12,0.12,i*0.2);
                tone(1100,'square',0.12,0.1,i*0.2+0.1);
            }
            [523,659,784,1047].forEach((f,i)=>tone(f,'sine',0.3,0.2,0.7+i*0.12));
            noise(0.15,0.06,0.6);
        },
        // Bonus cell reveal
        cellReveal(tier){
            ensure();
            if(tier==='low'){
                tone(600,'sine',0.12,0.2);tone(800,'sine',0.15,0.2,0.06);
            }else if(tier==='mid'){
                tone(600,'sine',0.1,0.2);tone(800,'sine',0.1,0.2,0.06);tone(1000,'sine',0.15,0.2,0.12);
            }else if(tier==='high'){
                [600,800,1000,1200].forEach((f,i)=>tone(f,'sine',0.18,0.25,i*0.06));
                noise(0.06,0.04,0.2);
            }else{
                [600,800,1000,1200,1600].forEach((f,i)=>{
                    tone(f,'sine',0.25,0.3,i*0.07);
                    tone(f*1.5,'triangle',0.15,0.1,i*0.07);
                });
                for(let i=0;i<5;i++)tone(1500+Math.random()*1500,'sine',0.1,0.05,0.35+i*0.04);
            }
        },
        // Bonus collect: satisfying cash-out
        bonusCollect(){
            ensure();
            [784,988,1175,1568].forEach((f,i)=>{
                tone(f,'sine',0.3,0.25,i*0.1);
                tone(f*0.5,'triangle',0.25,0.12,i*0.1);
            });
            noise(0.1,0.04,0.4);
        },
        // Bet change click
        click(){
            ensure();
            tone(1200,'sine',0.04,0.1);
        },
        // Counting coins tick
        coinTick(){
            ensure();
            tone(2400+Math.random()*600,'sine',0.03,0.06);
        },
        // Vault meter increase
        meterUp(){
            ensure();
            tone(440,'sine',0.08,0.12);
            tone(660,'sine',0.1,0.1,0.05);
        },
        // Heartbeat thump for scatter anticipation
        heartbeat(){
            ensure();
            tone(55,'sine',0.15,0.35);
            tone(55,'sine',0.12,0.3,0.18);
            noise(0.05,0.03,0.05);
        },
        // Rising tension sound
        tensionRiser(){
            ensure();
            const t=ctx.currentTime;
            const buf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
            const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);
            const s=ctx.createBufferSource(),g=ctx.createGain(),f=ctx.createBiquadFilter();
            s.buffer=buf;f.type='bandpass';
            f.frequency.setValueAtTime(200,t);f.frequency.exponentialRampToValueAtTime(4000,t+2);f.Q.value=5;
            g.gain.setValueAtTime(0.08,t);g.gain.linearRampToValueAtTime(0.15,t+1.5);g.gain.exponentialRampToValueAtTime(0.001,t+2);
            s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);s.stop(t+2);
        }
    };
})();
// Init audio on first interaction
document.addEventListener('click',()=>SFX.init(),{once:true});

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let balance=1000, bet=1, totalWon=0, totalBet=0;
let spinning=false, autoplay=false, inBonus=false;
let autoSpinsLeft=0, autoSpinsTotal=0;
let speedMode=0; // 0=Normal, 1=Turbo, 2=Super Turbo
function isTurbo(){return speedMode>=1;}
function isSuperTurbo(){return speedMode===2;}
const BETS=[0.20,0.50,1,2,5,10,25,50];
let betIdx=2;

// ‚îÄ‚îÄ‚îÄ BONUS STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let spinsSinceBonus=0;
let nextBonusAt=25+Math.floor(Math.random()*51);
let bonusPicks=0, bonusMaxPicks=5, bonusTotalWin=0, bonusBetAtTrigger=1;
let bonusCellValues=[];

// ‚îÄ‚îÄ‚îÄ SCATTER / FREE SPINS STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let spinsSinceLastScatterBonus=0;
let nextScatterAt=25+Math.floor(Math.random()*51); // 25-75
const FREE_SPIN_AWARDS={3:10,4:15,5:25};
const FREE_SPIN_MULTIPLIERS={3:2,4:3,5:5};
let inFreeSpins=false, freeSpinsRemaining=0, freeSpinsTotalWin=0;
let freeSpinsMultiplier=1, freeSpinsBet=1, freeSpinsCount=0, freeSpinsTotalAwarded=0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKGROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bgLayer=new PIXI.Container(); app.stage.addChild(bgLayer);
const BG_URI="symbols/background.jpg";
const LOCK_URI="symbols/lock.png";
const UNLOCK_URI="symbols/unlock.png";


const bgSprite=PIXI.Sprite.from(BG_URI);
bgSprite.anchor.set(0.5);bgSprite.x=W/2;bgSprite.y=H/2;
bgSprite.width=W;bgSprite.height=H;
bgLayer.addChild(bgSprite);
// Darken overlay so symbols stay readable
const bgDarken=new PIXI.Graphics();bgDarken.beginFill(0x000000,0.3);bgDarken.drawRect(0,0,W,H);bgDarken.endFill();bgLayer.addChild(bgDarken);

// Neon flicker glow overlays (behind symbols)
const neonGlow1=new PIXI.Graphics();neonGlow1.beginFill(CYAN,0.06);neonGlow1.drawEllipse(W*0.5,H*0.2,W*0.5,H*0.35);neonGlow1.endFill();bgLayer.addChild(neonGlow1);
const neonGlow2=new PIXI.Graphics();neonGlow2.beginFill(MAGENTA,0.045);neonGlow2.drawEllipse(W*0.8,H*0.7,W*0.4,H*0.3);neonGlow2.endFill();bgLayer.addChild(neonGlow2);
const neonGlow3=new PIXI.Graphics();neonGlow3.beginFill(PURPLE,0.04);neonGlow3.drawEllipse(W*0.2,H*0.6,W*0.35,H*0.3);neonGlow3.endFill();bgLayer.addChild(neonGlow3);

// Floating dust particles (behind symbols)
class DustMote{
    constructor(){
        this.gfx=new PIXI.Graphics();
        this.reset(true);
        bgLayer.addChild(this.gfx);
    }
    reset(init=false){
        this.x=Math.random()*W;
        this.y=init?Math.random()*H:H+5;
        this.spd=0.05+Math.random()*0.15;
        this.drift=(Math.random()-0.5)*0.1;
        this.sz=0.5+Math.random()*1.5;
        this.maxA=0.15+Math.random()*0.35;
        this.ph=Math.random()*Math.PI*2;
        this.isCyan=Math.random()>0.3;
    }
    update(dt){
        this.y-=this.spd*dt;
        this.x+=this.drift*dt;
        this.ph+=0.01*dt;
        if(this.y<-10)this.reset();
        const a=this.maxA*(0.3+0.7*Math.abs(Math.sin(this.ph)));
        this.gfx.clear();
        this.gfx.beginFill(this.isCyan?CYAN:0xffffff,a);
        this.gfx.drawCircle(this.x,this.y,this.sz);
        this.gfx.endFill();
    }
}
const dustMotes=[];for(let i=0;i<30;i++)dustMotes.push(new DustMote());

class AmbientP{
    constructor(){this.gfx=new PIXI.Graphics();this.reset(true);bgLayer.addChild(this.gfx);}
    reset(init=false){this.x=Math.random()*W;this.y=init?Math.random()*H:H+10;this.spd=0.1+Math.random()*0.35;this.drift=(Math.random()-0.5)*0.25;this.sz=0.8+Math.random()*2.5;this.a=0.08+Math.random()*0.25;this.col=[CYAN,MAGENTA,PURPLE,0x4444aa,0x00ff88,0x8800ff][Math.floor(Math.random()*6)];this.ph=Math.random()*Math.PI*2;this.type=Math.random()<0.3?'line':'dot';this.len=this.type==='line'?8+Math.random()*20:0;this.angle=Math.random()*Math.PI*2;this.rotSpd=(Math.random()-0.5)*0.01;}
    update(dt){this.y-=this.spd*dt;this.x+=this.drift*dt;this.ph+=0.015*dt;this.angle+=this.rotSpd*dt;if(this.y<-20)this.reset();const alpha=this.a*(0.4+0.6*Math.sin(this.ph));this.gfx.clear();if(this.type==='line'){this.gfx.lineStyle(0.8,this.col,alpha);const dx=Math.cos(this.angle)*this.len/2,dy=Math.sin(this.angle)*this.len/2;this.gfx.moveTo(this.x-dx,this.y-dy);this.gfx.lineTo(this.x+dx,this.y+dy);}else{this.gfx.beginFill(this.col,alpha);this.gfx.drawCircle(this.x,this.y,this.sz);this.gfx.endFill();}}
}
const ambParts=[];for(let i=0;i<55;i++)ambParts.push(new AmbientP());
// Connection lines between nearby particles
const ambLineGfx=new PIXI.Graphics();bgLayer.addChild(ambLineGfx);
function drawAmbientLines(){
    ambLineGfx.clear();
    for(let i=0;i<ambParts.length;i++){
        for(let j=i+1;j<ambParts.length;j++){
            const dx=ambParts[i].x-ambParts[j].x,dy=ambParts[i].y-ambParts[j].y,d=Math.sqrt(dx*dx+dy*dy);
            if(d<80){const a=0.04*(1-d/80);ambLineGfx.lineStyle(0.5,CYAN,a);ambLineGfx.moveTo(ambParts[i].x,ambParts[i].y);ambLineGfx.lineTo(ambParts[j].x,ambParts[j].y);}
        }
    }
}
const gridGlow=new PIXI.Graphics();gridGlow.alpha=0.08;bgLayer.addChild(gridGlow);
function drawGlow(t){gridGlow.clear();const p=0.06+0.03*Math.sin(t*0.001);gridGlow.beginFill(CYAN,p);gridGlow.drawRoundedRect(GRID_X-20,GRID_Y-20,GRID_W+40,GRID_H+40,20);gridGlow.endFill();gridGlow.beginFill(MAGENTA,p*0.4);gridGlow.drawRoundedRect(GRID_X-10,GRID_Y-10,GRID_W+20,GRID_H+20,16);gridGlow.endFill();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REEL FRAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const reelLayer=new PIXI.Container();app.stage.addChild(reelLayer);
const reelBg=new PIXI.Graphics();reelBg.beginFill(0x03030a,0.55);reelBg.drawRoundedRect(GRID_X-6,GRID_Y-6,GRID_W+12,GRID_H+12,12);reelBg.endFill();reelLayer.addChild(reelBg);
const seps=new PIXI.Graphics();seps.lineStyle(1,CYAN,0.07);
for(let i=1;i<REELS;i++){const x=GRID_X+i*(SYM_W+REEL_GAP)-REEL_GAP/2;seps.moveTo(x,GRID_Y);seps.lineTo(x,GRID_Y+GRID_H);}
for(let r=1;r<ROWS;r++){seps.moveTo(GRID_X,GRID_Y+r*SYM_H);seps.lineTo(GRID_X+GRID_W,GRID_Y+r*SYM_H);}
reelLayer.addChild(seps);
const fb=new PIXI.Graphics();fb.lineStyle(1.5,CYAN,0.3);fb.drawRoundedRect(GRID_X-6,GRID_Y-6,GRID_W+12,GRID_H+12,12);reelLayer.addChild(fb);
function drawCorner(x,y,fx,fy){const g=new PIXI.Graphics();g.lineStyle(2,CYAN,0.6);g.moveTo(x,y+fy*20);g.lineTo(x,y);g.lineTo(x+fx*20,y);reelLayer.addChild(g);}
drawCorner(GRID_X-10,GRID_Y-10,1,1);drawCorner(GRID_X+GRID_W+10,GRID_Y-10,-1,1);
drawCorner(GRID_X-10,GRID_Y+GRID_H+10,1,-1);drawCorner(GRID_X+GRID_W+10,GRID_Y+GRID_H+10,-1,-1);

// ‚îÄ‚îÄ‚îÄ Symbol Textures ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SYM_ASSETS = {"W": "symbols/sym-w.png", "S": "symbols/sym-s.png", "H1": "symbols/sym-h1.png", "H2": "symbols/sym-h2.png", "H3": "symbols/sym-h3.png", "L1": "symbols/sym-l1.png", "L2": "symbols/sym-l2.png", "L3": "symbols/sym-l3.png", "L4": "symbols/sym-l4.png"};
const symTex={};
for(const[id,uri] of Object.entries(SYM_ASSETS))symTex[id]=PIXI.Texture.from(uri);

// ‚îÄ‚îÄ‚îÄ Reels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const reelMask=new PIXI.Graphics();reelMask.beginFill(0xffffff);reelMask.drawRoundedRect(GRID_X-4,GRID_Y-4,GRID_W+8,GRID_H+8,10);reelMask.endFill();reelLayer.addChild(reelMask);
const symLayer=new PIXI.Container();symLayer.mask=reelMask;reelLayer.addChild(symLayer);

const reels=[];
for(let r=0;r<REELS;r++){
    const reel={container:new PIXI.Container(),sprites:[]};
    reel.container.x=GRID_X+r*(SYM_W+REEL_GAP);reel.container.y=GRID_Y;
    for(let s=0;s<ROWS+6;s++){
        const sid=STRIPS[r][s%STRIPS[r].length];
        const sp=new PIXI.Sprite(symTex[sid]);sp.width=SYM_W-4;sp.height=SYM_H-4;sp.x=2;sp.y=s*SYM_H;sp.symId=sid;
        reel.sprites.push(sp);reel.container.addChild(sp);
    }
    symLayer.addChild(reel.container);reels.push(reel);
}

let currentGrid=[];
function initGrid(){
    currentGrid=[];
    for(let r=0;r<REELS;r++){const col=[];for(let row=0;row<ROWS;row++){col.push(STRIPS[r][row]);reels[r].sprites[row].texture=symTex[STRIPS[r][row]];reels[r].sprites[row].symId=STRIPS[r][row];reels[r].sprites[row].y=row*SYM_H;}currentGrid.push(col);}
}

function genOutcome(){
    const grid=[];
    for(let r=0;r<REELS;r++){const stop=Math.floor(Math.random()*STRIPS[r].length),strip=STRIPS[r],len=strip.length;grid.push([strip[stop%len],strip[(stop+1)%len],strip[(stop+2)%len]]);}
    // Scatter frequency control
    let sc=0;const scPos=[];
    for(let r=0;r<REELS;r++)for(let row=0;row<ROWS;row++)if(grid[r][row]==='S'){sc++;scPos.push({r,row});}
    const replacements=['L1','L2','L3','L4','H1','H2','H3'];
    if(spinsSinceLastScatterBonus<nextScatterAt){
        // Not due: cap at 2 scatters
        while(scPos.length>2){const idx=Math.floor(Math.random()*scPos.length);const{r,row}=scPos.splice(idx,1)[0];grid[r][row]=replacements[Math.floor(Math.random()*replacements.length)];}
    }else{
        // Due: ensure at least 3 scatters spread across different reels
        if(sc<3){
            const reelsWithSc=new Set(scPos.map(p=>p.r));
            const empties=[];
            for(let r=0;r<REELS;r++)for(let row=0;row<ROWS;row++)if(grid[r][row]!=='S')empties.push({r,row});
            while(sc<3){
                let cands=empties.filter(e=>!reelsWithSc.has(e.r));
                if(cands.length===0)cands=empties;
                const idx=Math.floor(Math.random()*cands.length);
                const pos=cands[idx];
                grid[pos.r][pos.row]='S';
                reelsWithSc.add(pos.r);
                empties.splice(empties.indexOf(pos),1);
                sc++;
            }
        }
    }
    return grid;
}

function genFreeSpinOutcome(){
    const grid=[];
    for(let r=0;r<REELS;r++){const stop=Math.floor(Math.random()*STRIPS[r].length),strip=STRIPS[r],len=strip.length;grid.push([strip[stop%len],strip[(stop+1)%len],strip[(stop+2)%len]]);}
    return grid;
}

function instantRevealReel(reel,idx,tgt){
    for(let s=0;s<ROWS;s++){reel.sprites[s].texture=symTex[tgt[idx][s]];reel.sprites[s].symId=tgt[idx][s];reel.sprites[s].y=s*SYM_H;reel.sprites[s].alpha=1;}
    reelFlash(idx);symbolLandPop(idx,tgt[idx]);
}

function animateReels(tgt){
    // Pre-scan for scatter anticipation (shared by all modes)
    let anticipationStartReel=-1,earlyScCount=0;
    for(let r=0;r<REELS;r++){
        if(tgt[r].includes('S'))earlyScCount++;
        if(earlyScCount>=2&&r<REELS-1){anticipationStartReel=r+1;break;}
    }
    const hasAnticipation=anticipationStartReel>0;

    // ‚îÄ‚îÄ SUPER TURBO: instant flash reveal (with scatter anticipation support) ‚îÄ‚îÄ
    if(isSuperTurbo()){
        return new Promise(async resolve=>{
            if(!hasAnticipation){
                // No anticipation: instant flash all reels with tiny stagger
                for(let idx=0;idx<REELS;idx++){
                    instantRevealReel(reels[idx],idx,tgt);
                    if(tgt[idx].includes('S')){SFX.scatterLand();scatterFlash(idx);}
                }
                SFX.reelStop(2);
                // Brief white flash overlay
                const flash=new PIXI.Graphics();flash.beginFill(0xffffff,0.12);flash.drawRect(GRID_X,GRID_Y,GRID_W,GRID_H);flash.endFill();reelLayer.addChild(flash);
                let fa=0.12;const ff=()=>{fa-=0.02;flash.alpha=fa;if(fa>0)requestAnimationFrame(ff);else{reelLayer.removeChild(flash);flash.destroy();}};requestAnimationFrame(ff);
                await new Promise(r=>setTimeout(r,80));
                resolve();
            }else{
                // Instant reveal reels before anticipation, then slow the rest
                let scattersLanded=0;
                for(let idx=0;idx<anticipationStartReel;idx++){
                    instantRevealReel(reels[idx],idx,tgt);
                    SFX.reelStop(idx);
                    if(tgt[idx].includes('S')){scattersLanded++;SFX.scatterLand();scatterFlash(idx);}
                }
                if(scattersLanded>=2)startAnticipation();
                // Slow-animate remaining reels
                let settled=0;const totalSlow=REELS-anticipationStartReel;
                const stReelLanded=new Array(REELS).fill(false);let stScatterResolved=false;
                for(let i=0;i<anticipationStartReel;i++)stReelLanded[i]=true;
                reels.forEach((reel,idx)=>{
                    if(idx<anticipationStartReel)return;
                    const pause=400+(idx-anticipationStartReel)*300;
                    const dur=1500+(idx-anticipationStartReel)*200;
                    const strip=STRIPS[idx],spinSyms=[];
                    for(let i=0;i<30+idx*5;i++)spinSyms.push(strip[Math.floor(Math.random()*strip.length)]);
                    spinSyms.push(...tgt[idx]);
                    const ts=spinSyms.length-ROWS,st=performance.now()+pause;
                    const bounceDur=120,bounceAmt=0.35;
                    let bouncing=false,landed=false;
                    const stBlurF=new PIXI.filters.BlurFilter();stBlurF.blurX=0;stBlurF.blurY=0;stBlurF.quality=4;
                    reel.container.filters=[stBlurF];
                    function easeSlot(t){if(t<0.12)return t/0.12*0.2;if(t<0.4)return 0.2+(t-0.12)/0.28*0.35;const d=(t-0.4)/0.6;return 0.55+0.45*(1-Math.pow(1-d,3.2));}
                    function tick(now){
                        if(stReelLanded[idx])return;
                        const el=now-st;if(el<0){requestAnimationFrame(tick);return;}
                        if(!bouncing){
                            const prog=Math.min(el/dur,1),e=Math.min(easeSlot(prog),1);
                            const step=e*ts,is=Math.floor(step),fr=step-is;
                            const speed=prog<0.12?prog/0.12:prog>0.4?Math.pow((1-prog)/0.6,1.5):1;
                            const cs=Math.max(0,Math.min(1,speed));
                            stBlurF.blurY=cs*12;
                            for(let s=-1;s<=ROWS;s++){const sprIdx=s+1;if(sprIdx<0||sprIdx>=reel.sprites.length)continue;const sp=reel.sprites[sprIdx];const si=Math.min(Math.max(is+s,0),spinSyms.length-1),sid=spinSyms[si];if(sp.symId!==sid){sp.texture=symTex[sid];sp.symId=sid;}sp.height=SYM_H-4;sp.y=s*SYM_H-fr*SYM_H;if(s===-1){sp.alpha=Math.max(0,Math.min(1,(sp.y+SYM_H)/SYM_H));}else if(s===ROWS){sp.alpha=Math.max(0,Math.min(1,1-(sp.y-(ROWS-1)*SYM_H)/SYM_H));}else{sp.alpha=1;}}
                            if(prog>=1){bouncing=true;stBlurF.blurY=0;for(let s=0;s<reel.sprites.length;s++){reel.sprites[s].height=SYM_H-4;reel.sprites[s].alpha=s<ROWS?1:0;}for(let s=0;s<ROWS;s++){reel.sprites[s].texture=symTex[tgt[idx][s]];reel.sprites[s].symId=tgt[idx][s];reel.sprites[s].y=s*SYM_H;reel.sprites[s].alpha=1;}requestAnimationFrame(tick);return;}
                        }else if(!landed){
                            const bt=Math.min((now-st-dur)/bounceDur,1);
                            const bounce=bounceAmt*Math.sin(bt*Math.PI)*Math.pow(1-bt,1.5);
                            for(let s=0;s<ROWS;s++){reel.sprites[s].y=s*SYM_H+bounce*SYM_H;}
                            if(bt>=1){landed=true;stReelLanded[idx]=true;SFX.reelStop(idx);
                                reel.container.filters=null;
                                if(tgt[idx].includes('S')){scattersLanded++;SFX.scatterLand();scatterFlash(idx);
                                    if(scattersLanded>=3&&!stScatterResolved){
                                        stScatterResolved=true;
                                        for(let i=0;i<REELS;i++){if(!stReelLanded[i]){stReelLanded[i]=true;instantRevealReel(reels[i],i,tgt);reels[i].container.filters=null;SFX.reelStop(i);if(tgt[i].includes('S')){SFX.scatterLand();scatterFlash(i);}}}
                                        stopAnticipation();resolve();return;
                                    }
                                }
                                for(let s=0;s<ROWS;s++){reel.sprites[s].y=s*SYM_H;}
                                for(let s=ROWS;s<reel.sprites.length;s++){reel.sprites[s].alpha=0;reel.sprites[s].height=SYM_H-4;}
                                reelFlash(idx);symbolLandPop(idx,tgt[idx]);settled++;
                                if(settled===totalSlow){stopAnticipation();resolve();}
                                return;}
                        }
                        requestAnimationFrame(tick);
                    }
                    requestAnimationFrame(tick);
                });
            }
        });
    }

    // ‚îÄ‚îÄ NORMAL / TURBO: full reel spinning animation with motion blur ‚îÄ‚îÄ
    return new Promise(resolve=>{
        const bd=isTurbo()?80:200,sd=isTurbo()?500:1200;let settled=0;
        let scattersLanded=0,anticipationActive=false;
        const reelLanded=new Array(REELS).fill(false);let scatterResolved=false;
        reels.forEach((reel,idx)=>{
            const isSlowReel=hasAnticipation&&idx>=anticipationStartReel;
            const anticipationPause=isTurbo()?400:800;
            const delay=isSlowReel?anticipationStartReel*bd+sd+anticipationStartReel*(isTurbo()?80:180)+anticipationPause+(idx-anticipationStartReel)*(isTurbo()?300:600):idx*bd;
            const dur=isSlowReel?(isTurbo()?1500:2500)+(idx-anticipationStartReel)*(isTurbo()?200:400):sd+idx*(isTurbo()?80:180);
            const strip=STRIPS[idx],spinSyms=[];
            const extraSyms=isSlowReel?(isTurbo()?30+idx*5:45+idx*8):(isTurbo()?14+idx*3:20+idx*4);
            for(let i=0;i<extraSyms;i++)spinSyms.push(strip[Math.floor(Math.random()*strip.length)]);
            spinSyms.push(...tgt[idx]);
            const ts=spinSyms.length-ROWS,st=performance.now()+delay;
            const bounceDur=isTurbo()?120:220;
            const bounceAmt=0.35;
            let bouncing=false,landed=false;
            // Real vertical blur filter on the reel container
            const blurFilter=new PIXI.filters.BlurFilter();
            blurFilter.blurX=0;blurFilter.blurY=0;blurFilter.quality=4;
            reel.container.filters=[blurFilter];
            function easeSlot(t){
                if(t<0.12)return t/0.12*0.2;
                if(t<0.4)return 0.2+(t-0.12)/0.28*0.35;
                const d=(t-0.4)/0.6;
                return 0.55+0.45*(1-Math.pow(1-d,3.2));
            }
            function tick(now){
                if(reelLanded[idx])return;
                const el=now-st;if(el<0){requestAnimationFrame(tick);return;}
                if(!bouncing){
                    const prog=Math.min(el/dur,1);
                    const e=Math.min(easeSlot(prog),1);
                    const step=e*ts,is=Math.floor(step),fr=step-is;
                    // Speed: ramps up quickly, holds, then eases down
                    const speed=prog<0.12?prog/0.12:prog>0.4?Math.pow((1-prog)/0.6,1.5):1;
                    const clampSpeed=Math.max(0,Math.min(1,speed));
                    // Apply vertical blur proportional to speed
                    blurFilter.blurY=clampSpeed*12;
                    // Show ROWS+2 sprites for seamless scroll
                    for(let s=-1;s<=ROWS;s++){
                        const sprIdx=s+1;
                        if(sprIdx<0||sprIdx>=reel.sprites.length)continue;
                        const sp=reel.sprites[sprIdx];
                        const si=Math.min(Math.max(is+s,0),spinSyms.length-1),sid=spinSyms[si];
                        if(sp.symId!==sid){sp.texture=symTex[sid];sp.symId=sid;}
                        sp.height=SYM_H-4;
                        sp.y=s*SYM_H-fr*SYM_H;
                        // Edge fade for sprites partially outside visible area
                        if(s===-1){sp.alpha=Math.max(0,Math.min(1,(sp.y+SYM_H)/SYM_H));}
                        else if(s===ROWS){sp.alpha=Math.max(0,Math.min(1,1-(sp.y-(ROWS-1)*SYM_H)/SYM_H));}
                        else{sp.alpha=1;}
                    }
                    if(prog>=1){
                        bouncing=true;
                        blurFilter.blurY=0;
                        for(let s=0;s<reel.sprites.length;s++){reel.sprites[s].height=SYM_H-4;reel.sprites[s].alpha=s<ROWS?1:0;}
                        for(let s=0;s<ROWS;s++){reel.sprites[s].texture=symTex[tgt[idx][s]];reel.sprites[s].symId=tgt[idx][s];reel.sprites[s].y=s*SYM_H;reel.sprites[s].alpha=1;}
                        requestAnimationFrame(tick);return;
                    }
                }else if(!landed){
                    const bt=Math.min((now-st-dur)/bounceDur,1);
                    const bounce=bounceAmt*Math.sin(bt*Math.PI)*Math.pow(1-bt,1.5);
                    for(let s=0;s<ROWS;s++){reel.sprites[s].y=s*SYM_H+bounce*SYM_H;}
                    if(bt>=1){
                        landed=true;reelLanded[idx]=true;
                        SFX.reelStop(idx);
                        reel.container.filters=null;
                        if(tgt[idx].includes('S')){
                            scattersLanded++;
                            SFX.scatterLand();
                            scatterFlash(idx);
                            if(scattersLanded>=3&&!scatterResolved){
                                scatterResolved=true;
                                for(let i=0;i<REELS;i++){if(!reelLanded[i]){reelLanded[i]=true;instantRevealReel(reels[i],i,tgt);reels[i].container.filters=null;SFX.reelStop(i);if(tgt[i].includes('S')){SFX.scatterLand();scatterFlash(i);}}}
                                settled=REELS;stopAnticipation();resolve();return;
                            }
                            if(scattersLanded>=2&&!anticipationActive&&settled<REELS-1){
                                anticipationActive=true;
                                startAnticipation();
                            }
                        }
                        for(let s=0;s<ROWS;s++){reel.sprites[s].y=s*SYM_H;}
                        for(let s=ROWS;s<reel.sprites.length;s++){reel.sprites[s].alpha=0;reel.sprites[s].height=SYM_H-4;}
                        reelFlash(idx);symbolLandPop(idx,tgt[idx]);settled++;
                        if(settled===REELS){stopAnticipation();resolve();}
                        return;
                    }
                }
                requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        });
    });
}

function reelFlash(ri){
    const f=new PIXI.Graphics();f.beginFill(CYAN,0.08);f.drawRect(GRID_X+ri*(SYM_W+REEL_GAP),GRID_Y,SYM_W,GRID_H);f.endFill();reelLayer.addChild(f);
    let a=0.12;const fade=()=>{a-=0.015;f.alpha=a;if(a>0)requestAnimationFrame(fade);else{reelLayer.removeChild(f);f.destroy();}};requestAnimationFrame(fade);
}

function symbolLandPop(ri,syms){
    const reel=reels[ri];
    for(let s=0;s<ROWS;s++){
        const sp=reel.sprites[s];
        const origW=SYM_W-4,origH=SYM_H-4,origX=2,origY=s*SYM_H;
        const symDef=SYMS[syms[s]];
        const col=symDef?.colors?.[0]||CYAN;
        // Glow ring behind symbol
        const glow=new PIXI.Graphics();
        glow.beginFill(col,0.12);glow.drawRoundedRect(GRID_X+ri*(SYM_W+REEL_GAP)+4,GRID_Y+s*SYM_H+4,SYM_W-8,SYM_H-8,8);glow.endFill();
        reelLayer.addChild(glow);
        // Scale pop animation
        const start=performance.now(),dur=300;
        const delay=s*40;
        function pop(now){
            const el=now-start-delay;
            if(el<0){requestAnimationFrame(pop);return;}
            const t=Math.min(el/dur,1);
            // Overshoot ease
            const ease=t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
            const scale=1+0.08*Math.sin(t*Math.PI);
            sp.width=origW*scale;sp.height=origH*scale;
            sp.x=origX-(origW*scale-origW)/2;
            sp.y=origY-(origH*scale-origH)/2;
            glow.alpha=0.15*Math.sin(t*Math.PI);
            if(t>=1){
                sp.width=origW;sp.height=origH;sp.x=origX;sp.y=origY;
                reelLayer.removeChild(glow);glow.destroy();
                return;
            }
            requestAnimationFrame(pop);
        }
        requestAnimationFrame(pop);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCATTER ANTICIPATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let anticipationOverlay=null,anticipationPulseId=null,heartbeatInterval=null;

function scatterFlash(ri){
    const f=new PIXI.Graphics();f.beginFill(YELLOW,0.2);f.drawRect(GRID_X+ri*(SYM_W+REEL_GAP),GRID_Y,SYM_W,GRID_H);f.endFill();reelLayer.addChild(f);
    let a=0.35;const fade=()=>{a-=0.01;f.alpha=a;if(a>0)requestAnimationFrame(fade);else{reelLayer.removeChild(f);f.destroy();}};requestAnimationFrame(fade);
}

function startAnticipation(){
    SFX.tensionRiser();
    anticipationOverlay=new PIXI.Graphics();app.stage.addChild(anticipationOverlay);
    let phase=0;
    function pulse(){
        if(!anticipationOverlay)return;
        phase+=0.08;
        const intensity=0.03+0.04*Math.sin(phase);
        anticipationOverlay.clear();
        anticipationOverlay.lineStyle(3,YELLOW,0.3+0.3*Math.sin(phase));
        anticipationOverlay.drawRect(GRID_X-2,GRID_Y-2,GRID_W+4,GRID_H+4);
        anticipationOverlay.beginFill(0x000000,intensity);
        anticipationOverlay.drawRect(0,0,W,H);
        anticipationOverlay.endFill();
        anticipationPulseId=requestAnimationFrame(pulse);
    }
    anticipationPulseId=requestAnimationFrame(pulse);
    document.getElementById('game-wrapper').classList.add('anticipation-pulse');
    heartbeatInterval=setInterval(()=>SFX.heartbeat(),700);
}

function stopAnticipation(){
    if(anticipationOverlay){app.stage.removeChild(anticipationOverlay);anticipationOverlay.destroy();anticipationOverlay=null;}
    if(anticipationPulseId){cancelAnimationFrame(anticipationPulseId);anticipationPulseId=null;}
    if(heartbeatInterval){clearInterval(heartbeatInterval);heartbeatInterval=null;}
    document.getElementById('game-wrapper').classList.remove('anticipation-pulse');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const partLayer=new PIXI.Container();app.stage.addChild(partLayer);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREMIUM SYMBOL GLOW SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const glowLayer=new PIXI.Container();
reelLayer.addChild(glowLayer);
const PREMIUM_IDS=new Set(['W','S','H1','H2','H3']);
const GLOW_COLORS={W:CYAN,S:YELLOW,H1:0x00bfff,H2:MAGENTA,H3:GREEN};
let activeGlows=[];
let glowTime=0;

function clearPremiumGlow(){
    activeGlows.forEach(g=>{glowLayer.removeChild(g.outer);g.outer.destroy();glowLayer.removeChild(g.inner);g.inner.destroy();});
    activeGlows=[];glowTime=0;
    // Reset any pulsed sprites to default anchor/position
    for(let r=0;r<REELS;r++){
        for(let row=0;row<ROWS;row++){
            const sp=reels[r].sprites[row];
            sp.anchor.set(0);
            sp.x=2;
            sp.y=row*SYM_H;
            sp.width=SYM_W-4;
            sp.height=SYM_H-4;
        }
    }
}

function startPremiumGlow(grid){
    clearPremiumGlow();
    for(let r=0;r<REELS;r++){
        for(let row=0;row<ROWS;row++){
            const sid=grid[r][row];
            if(!PREMIUM_IDS.has(sid))continue;
            const col=GLOW_COLORS[sid]||CYAN;
            const cx=GRID_X+r*(SYM_W+REEL_GAP);
            const cy=GRID_Y+row*SYM_H;
            // Outer glow box
            const outer=new PIXI.Graphics();
            outer.lineStyle(2,col,0.4);
            outer.drawRoundedRect(cx+1,cy+1,SYM_W-2,SYM_H-2,8);
            glowLayer.addChild(outer);
            // Inner soft fill
            const inner=new PIXI.Graphics();
            inner.beginFill(col,0.06);
            inner.drawRoundedRect(cx+3,cy+3,SYM_W-6,SYM_H-6,6);
            inner.endFill();
            glowLayer.addChild(inner);
            activeGlows.push({outer,inner,col,phase:r*0.7+row*1.1});
        }
    }
}

function updatePremiumGlow(dt){
    if(activeGlows.length===0)return;
    glowTime+=dt*0.05;
    activeGlows.forEach(g=>{
        const pulse=0.35+0.65*Math.sin(glowTime*2.5+g.phase);
        const pulse2=0.3+0.7*Math.sin(glowTime*2.5+g.phase+0.3);
        g.outer.alpha=pulse;
        g.inner.alpha=pulse2*0.8;
    });
    // Subtle scale pulse on premium symbol sprites
    for(let r=0;r<REELS;r++){
        for(let row=0;row<ROWS;row++){
            const sp=reels[r].sprites[row];
            if(PREMIUM_IDS.has(sp.symId)){
                const p=0.7+row*1.1+r*0.7;
                const s=1+0.03*Math.sin(glowTime*2.5+p);
                sp.anchor.set(0.5);
                sp.x=(SYM_W-4)/2+2;
                sp.y=row*SYM_H+(SYM_H-4)/2+2;
                sp.scale.set(s*(SYM_W-4)/sp.texture.width,s*(SYM_H-4)/sp.texture.height);
            }
        }
    }
}
class WP{
    constructor(x,y,col,type='spark'){
        this.gfx=new PIXI.Graphics();this.x=x;this.y=y;this.type=type;this.col=col;
        if(type==='spark'){this.vx=(Math.random()-0.5)*8;this.vy=-2-Math.random()*6;this.g=0.12;this.life=40+Math.random()*40;this.sz=1.5+Math.random()*2.5;}
        else if(type==='ring'){this.r=0;this.mr=60+Math.random()*40;this.spd=2+Math.random()*2;this.life=30;}
        else{this.vx=(Math.random()-0.5)*3;this.vy=-1-Math.random()*3;this.life=20+Math.random()*25;this.sz=2+Math.random()*3;this.g=0.05;}
        this.ml=this.life;this.alive=true;partLayer.addChild(this.gfx);
    }
    update(){
        this.life--;if(this.life<=0){this.alive=false;return;}const t=1-this.life/this.ml;this.gfx.clear();
        if(this.type==='spark'){this.x+=this.vx;this.y+=this.vy;this.vy+=this.g;this.vx*=0.98;this.gfx.beginFill(this.col,1-t*t);this.gfx.drawCircle(this.x,this.y,this.sz*(1-t*0.5));this.gfx.endFill();}
        else if(this.type==='ring'){this.r+=this.spd;this.gfx.lineStyle(2*(1-t),this.col,(1-t)*0.6);this.gfx.drawCircle(this.x,this.y,this.r);}
        else{this.x+=this.vx;this.y+=this.vy;this.vy+=this.g;this.gfx.beginFill(this.col,0.8*(1-t));this.gfx.drawCircle(this.x,this.y,this.sz*(1-t*0.7));this.gfx.endFill();}
    }
    destroy(){partLayer.removeChild(this.gfx);this.gfx.destroy();}
}
let parts=[];
function spawnWinP(wins){wins.forEach(w=>{const pl=PAYLINES[w.line-1],c=SYMS[w.symbol]?.colors[0]||CYAN;for(let r=0;r<w.count;r++){const cx=GRID_X+r*(SYM_W+REEL_GAP)+SYM_W/2,cy=GRID_Y+pl[r]*SYM_H+SYM_H/2;for(let i=0;i<8;i++)parts.push(new WP(cx,cy,c,'spark'));parts.push(new WP(cx,cy,c,'ring'));}});}
function spawnMega(){const cx=W/2,cy=H/2,cs=[CYAN,MAGENTA,YELLOW,GREEN,PURPLE];for(let i=0;i<60;i++)parts.push(new WP(cx+(Math.random()-0.5)*300,cy+(Math.random()-0.5)*200,cs[i%5],'spark'));for(let i=0;i<5;i++)parts.push(new WP(cx+(Math.random()-0.5)*200,cy+(Math.random()-0.5)*100,YELLOW,'ring'));for(let i=0;i<25;i++)parts.push(new WP(cx+(Math.random()-0.5)*400,cy+(Math.random()-0.5)*200,cs[i%5],'trail'));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYLINES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const plLayer=new PIXI.Container();app.stage.addChild(plLayer);
const PLC=[CYAN,MAGENTA,YELLOW,GREEN,PURPLE,0xff6600,0x00aaff,0xff3366,0x66ff33,0xaa33ff];
let winLineTimer=null;

function drawWL(wins){
    plLayer.removeChildren();
    if(winLineTimer){clearTimeout(winLineTimer);winLineTimer=null;}
    if(wins.length===0)return;
    if(wins.length===1){drawSingleLine(wins[0],0,true);return;}
    // Cycle through each line, then show all
    let step=0;const totalSteps=wins.length+1;
    function cycle(){
        plLayer.removeChildren();
        if(step<wins.length){
            drawSingleLine(wins[step],step,true);
            step++;
            winLineTimer=setTimeout(cycle,1200);
        }else{
            // Show all lines together
            wins.forEach((w,i)=>drawSingleLine(w,i,false));
            step=0;
            winLineTimer=setTimeout(cycle,2000);
        }
    }
    cycle();
}

function drawSingleLine(w,colorIdx,animate){
    const pl=PAYLINES[w.line-1],c=PLC[colorIdx%PLC.length];
    const points=[];
    for(let r=0;r<REELS;r++){
        points.push({x:GRID_X+r*(SYM_W+REEL_GAP)+SYM_W/2, y:GRID_Y+pl[r]*SYM_H+SYM_H/2});
    }
    
    // Highlight winning symbol cells
    const cellG=new PIXI.Graphics();
    for(let r=0;r<w.count;r++){
        const cx=GRID_X+r*(SYM_W+REEL_GAP), cy=GRID_Y+pl[r]*SYM_H;
        cellG.lineStyle(2,c,0.5);cellG.beginFill(c,0.08);
        cellG.drawRoundedRect(cx+2,cy+2,SYM_W-4,SYM_H-4,8);cellG.endFill();
    }
    plLayer.addChild(cellG);
    
    // Neon line layers ‚Äî wide diffuse outer ‚Üí mid glow ‚Üí bright core ‚Üí white hot center
    const neonLayers=[
        {width:18, alpha:0.04},
        {width:12, alpha:0.08},
        {width:7, alpha:0.15},
        {width:4, alpha:0.6},
        {width:2.5, alpha:0.9},
    ];
    const lineGfx=[];
    neonLayers.forEach(layer=>{
        const g=new PIXI.Graphics();
        g.lineStyle(layer.width, c, layer.alpha);
        points.forEach((p,i)=>i===0?g.moveTo(p.x,p.y):g.lineTo(p.x,p.y));
        plLayer.addChild(g);
        lineGfx.push(g);
    });
    // White-hot core
    const coreG=new PIXI.Graphics();
    coreG.lineStyle(1.2, 0xffffff, 0.7);
    points.forEach((p,i)=>i===0?coreG.moveTo(p.x,p.y):coreG.lineTo(p.x,p.y));
    plLayer.addChild(coreG);
    lineGfx.push(coreG);
    
    // Glowing dots at winning positions
    const dotG=new PIXI.Graphics();
    for(let r=0;r<w.count;r++){
        // Outer glow
        dotG.lineStyle(0);dotG.beginFill(c,0.15);
        dotG.drawCircle(points[r].x,points[r].y,10);dotG.endFill();
        // Mid glow
        dotG.beginFill(c,0.4);
        dotG.drawCircle(points[r].x,points[r].y,6);dotG.endFill();
        // Core
        dotG.beginFill(c,0.9);
        dotG.drawCircle(points[r].x,points[r].y,4);dotG.endFill();
        // White center
        dotG.beginFill(0xffffff,0.8);
        dotG.drawCircle(points[r].x,points[r].y,2);dotG.endFill();
    }
    plLayer.addChild(dotG);
    
    // Animate in
    const all=[cellG,...lineGfx,dotG];
    if(animate){
        all.forEach(o=>o.alpha=0);
        const start=performance.now();
        function fadeIn(now){
            const p=Math.min((now-start)/250,1);
            const ease=1-Math.pow(1-p,3);
            all.forEach(o=>o.alpha=ease);
            if(p<1)requestAnimationFrame(fadeIn);
        }
        requestAnimationFrame(fadeIn);
    }
    
    // Pulse glow
    let pulsePhase=Math.random()*Math.PI*2;
    function pulse(){
        if(!lineGfx[0].parent)return;
        pulsePhase+=0.05;
        const p=0.7+0.3*Math.sin(pulsePhase);
        // Pulse the outer glow layers
        lineGfx[0].alpha=0.04*p*1.5;
        lineGfx[1].alpha=0.08*p*1.3;
        lineGfx[2].alpha=0.15*p*1.2;
        cellG.alpha=0.6+0.4*Math.sin(pulsePhase);
        dotG.alpha=0.7+0.3*Math.sin(pulsePhase);
        requestAnimationFrame(pulse);
    }
    requestAnimationFrame(pulse);
}

function clearWinLines(){
    plLayer.removeChildren();
    if(winLineTimer){clearTimeout(winLineTimer);winLineTimer=null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVALUATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function evalSpin(grid){
    let tlp=0;const wins=[];
    PAYLINES.forEach((pl,idx)=>{
        const syms=pl.map((row,reel)=>grid[reel][row]);let ps=null;
        for(const s of syms){if(s==='S'){ps=null;break;}if(s!=='W'){ps=s;break;}}
        if(!ps&&syms.every(s=>s==='W'))ps='W';if(!ps)return;
        let cnt=0;for(const s of syms){if(s===ps||s==='W')cnt++;else break;}
        if(cnt>=3&&PAYTABLE[ps]?.[cnt]){wins.push({line:idx+1,symbol:ps,count:cnt,payout:PAYTABLE[ps][cnt]});tlp+=PAYTABLE[ps][cnt];}
    });
    let mult=tlp/PAYLINES.length;
    let sc=0;for(const col of grid)for(const s of col)if(s==='S')sc++;
    if(SCATTER_PAYS[sc])mult+=SCATTER_PAYS[sc];
    return{mult,wins,sc};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BONUS ‚Äî HACK THE VAULT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const BONUS_CELLS=12, BONUS_MAX_PICKS=5;
const BONUS_PRIZES=[
    {mult:2,tier:'low',icon:'unlock',label:'2\u00d7'},{mult:3,tier:'low',icon:'unlock',label:'3\u00d7'},
    {mult:5,tier:'low',icon:'unlock',label:'5\u00d7'},{mult:5,tier:'low',icon:'unlock',label:'5\u00d7'},
    {mult:8,tier:'mid',icon:'\ud83d\udcbe',label:'8\u00d7'},{mult:10,tier:'mid',icon:'\ud83d\udcbe',label:'10\u00d7'},
    {mult:10,tier:'mid',icon:'\ud83d\udcbe',label:'10\u00d7'},{mult:15,tier:'mid',icon:'\ud83d\udcbe',label:'15\u00d7'},
    {mult:25,tier:'high',icon:'\u26a1',label:'25\u00d7'},{mult:30,tier:'high',icon:'\u26a1',label:'30\u00d7'},
    {mult:50,tier:'mega',icon:'\ud83d\udc8e',label:'50\u00d7'},{mult:100,tier:'mega',icon:'\ud83c\udfc6',label:'100\u00d7'},
];

function updateBonusMeter(){
    const pct=Math.min(spinsSinceBonus/nextBonusAt,1);
    const pctInt=Math.round(pct*100);
    const segs=document.querySelectorAll('.meter-segment');
    const filledCount=Math.round(pct*segs.length);
    segs.forEach((s,i)=>{
        const wasFilled=s.classList.contains('filled');
        if(i<filledCount){
            s.classList.add('filled');
            if(!wasFilled){s.classList.add('recent');SFX.meterUp();}
            setTimeout(()=>s.classList.remove('recent'),500);
        }else{
            s.classList.remove('filled','recent');
        }
    });
    document.getElementById('bonus-meter-pct').textContent=pctInt+'%';
    document.getElementById('bonus-meter-wrap').classList.toggle('hot',pct>0.7);
}

function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

// DEV: test button for bonus round
(function(){const b=document.createElement('button');b.textContent='‚ö° VAULT BREACH';b.style.cssText='position:fixed;bottom:8px;right:8px;z-index:9999;padding:4px 10px;font-size:11px;background:rgba(255,0,170,0.3);color:#f0a;border:1px solid #f0a;border-radius:4px;cursor:pointer;font-family:monospace;opacity:0.6;';b.onmouseenter=()=>b.style.opacity='1';b.onmouseleave=()=>b.style.opacity='0.6';b.onclick=()=>{if(!inBonus&&!spinning)startBonus();};document.body.appendChild(b);})();

function startBonus(){
    inBonus=true;
    SFX.bonusTrigger();
    clearPremiumGlow();
    // Auto spin paused during bonus
    

    bonusPicks=0;bonusTotalWin=0;bonusBetAtTrigger=bet;
    bonusCellValues=shuffle(BONUS_PRIZES);

    const gridEl=document.getElementById('bonus-grid');
    gridEl.innerHTML='';

    for(let i=0;i<BONUS_CELLS;i++){
        const cell=document.createElement('div');
        cell.className='bonus-cell';
        cell.dataset.index=i;
        cell.innerHTML='<div class="cell-icon"><img src="'+LOCK_URI+'" style="width:48px;height:auto;filter:drop-shadow(0 0 8px rgba(0,191,255,0.6))"></div><div class="cell-label">ENCRYPTED</div>';
        cell.addEventListener('click',()=>pickCell(i,cell));
        gridEl.appendChild(cell);
    }

    document.getElementById('bonus-picks-left').textContent=BONUS_MAX_PICKS;
    document.getElementById('bonus-running-total').textContent='$0.00';
    document.getElementById('bonus-total-value').textContent='$0.00';
    document.getElementById('bonus-collect-btn').style.display='none';
    document.getElementById('bonus-total-bar').classList.remove('visible');

    document.getElementById('bonus-overlay').classList.add('active');
}

function pickCell(idx,el){
    if(el.classList.contains('revealed')||el.classList.contains('locked'))return;
    if(bonusPicks>=BONUS_MAX_PICKS)return;

    bonusPicks++;
    const prize=bonusCellValues[idx];
    const win=prize.mult*bonusBetAtTrigger;
    bonusTotalWin+=win;

    el.classList.add('revealed','prize-'+prize.tier);
    SFX.cellReveal(prize.tier);
    const iconHtml=prize.icon==="unlock"?`<img src="${UNLOCK_URI}" style="width:40px;height:auto;filter:drop-shadow(0 0 6px rgba(0,240,255,0.6))">`:prize.icon;
    el.innerHTML=`<div class="cell-icon">${iconHtml}</div><div class="cell-value">${prize.label}</div><div class="cell-label">$${win.toFixed(2)}</div>`;

    document.getElementById('bonus-picks-left').textContent=BONUS_MAX_PICKS-bonusPicks;
    document.getElementById('bonus-running-total').textContent='$'+bonusTotalWin.toFixed(2);

    if(bonusPicks>=BONUS_MAX_PICKS)finishBonus();
}

function finishBonus(){
    // Reveal & lock remaining
    document.querySelectorAll('.bonus-cell:not(.revealed)').forEach(cell=>{
        const i=parseInt(cell.dataset.index),p=bonusCellValues[i];
        cell.classList.add('locked');
        setTimeout(()=>{cell.style.opacity='0.25';const dimIcon=p.icon==="unlock"?`<img src="${UNLOCK_URI}" style="width:40px;height:auto;opacity:0.4;filter:grayscale(0.5)">`:p.icon;cell.innerHTML=`<div class="cell-icon" style="opacity:0.4">${dimIcon}</div><div class="cell-value" style="opacity:0.3;font-family:'Orbitron',monospace;font-size:13px;color:#667">${p.label}</div>`;},400);
    });

    setTimeout(()=>{
        document.getElementById('bonus-total-bar').classList.add('visible');
        document.getElementById('bonus-total-value').textContent='$'+bonusTotalWin.toFixed(2);
        document.getElementById('bonus-collect-btn').style.display='block';
        document.getElementById('bonus-collect-btn').scrollIntoView({behavior:'smooth',block:'nearest'});
    },600);
}

function collectBonus(){
    SFX.bonusCollect();
    balance+=bonusTotalWin;totalWon+=bonusTotalWin;
    inBonus=false;
    document.getElementById('bonus-overlay').classList.remove('active');
    spinsSinceBonus=0;nextBonusAt=25+Math.floor(Math.random()*51);
    updateBonusMeter();updateUI();

    document.getElementById('ui-win').textContent=bonusTotalWin.toFixed(2);
    document.getElementById('ui-win').classList.add('win-active');
    spawnMega();

    const ov=document.getElementById('win-overlay');
    ov.classList.remove('show','mega','big');void ov.offsetWidth;
    document.getElementById('win-label').textContent='‚ö° VAULT CRACKED ‚ö°';
    document.getElementById('win-sub').textContent='BONUS COMPLETE';
    const amtEl=document.getElementById('win-amount');
    const cStart=performance.now();
    function cUp(now){const p=Math.min((now-cStart)/1400,1);amtEl.textContent='$'+(bonusTotalWin*(1-Math.pow(1-p,3))).toFixed(2);if(p<1)requestAnimationFrame(cUp);}
    requestAnimationFrame(cUp);
    ov.classList.add('show','mega');
    setTimeout(()=>ov.classList.remove('show','mega','big'),3000);
    if(autoplay&&autoSpinsLeft>0&&balance>=bet)setTimeout(()=>doSpin(),isSuperTurbo()?100:isTurbo()?300:700);else if(autoplay&&autoSpinsLeft<=0)stopAutoSpin();
}

document.getElementById('bonus-collect-btn').addEventListener('click',collectBonus);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FREE SPINS BONUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateFreeSpinHUD(){
    document.getElementById('fs-remaining').textContent=freeSpinsRemaining;
    document.getElementById('fs-counter').textContent=freeSpinsCount+' of '+freeSpinsTotalAwarded;
    document.getElementById('fs-multiplier').textContent=freeSpinsMultiplier+'x';
    document.getElementById('fs-total-win').textContent='$'+freeSpinsTotalWin.toFixed(2);
}

let speedModeBeforeFS=-1;
async function triggerFreeSpins(scatterCount){
    inFreeSpins=true;inBonus=true;
    // Auto spin paused during free spins
    // Disable super turbo during free spins so player can watch
    if(isSuperTurbo()){speedModeBeforeFS=speedMode;speedMode=1;updateSpeedBtns();}else{speedModeBeforeFS=-1;}
    freeSpinsRemaining=FREE_SPIN_AWARDS[scatterCount]||10;
    freeSpinsMultiplier=FREE_SPIN_MULTIPLIERS[scatterCount]||2;
    freeSpinsTotalWin=0;freeSpinsCount=0;freeSpinsBet=bet;
    freeSpinsTotalAwarded=freeSpinsRemaining;

    // Flashy intro
    SFX.bonusTrigger();
    const intro=document.getElementById('freespin-intro-overlay');
    document.getElementById('freespin-intro-count').textContent=freeSpinsRemaining;
    document.getElementById('freespin-intro-mult').textContent=freeSpinsMultiplier+'√ó MULTIPLIER';
    intro.classList.add('active');
    document.getElementById('canvas-container').classList.add('freespin-active');
    const gw=document.getElementById('game-wrapper');
    gw.classList.add('shake-mega');setTimeout(()=>gw.classList.remove('shake-mega'),600);
    spawnMega();

    await new Promise(r=>setTimeout(r,3000));
    intro.classList.remove('active');

    // Show HUD
    document.getElementById('freespin-hud').classList.add('active');
    updateFreeSpinHUD();
    doFreeSpin();
}

async function doFreeSpin(){
    if(freeSpinsRemaining<=0){endFreeSpins();return;}
    spinning=true;freeSpinsRemaining--;freeSpinsCount++;
    SFX.spinStart();
    const btn=document.getElementById('spin-btn');btn.disabled=true;btn.classList.add('spinning');
    document.getElementById('spin-btn-wrap').classList.add('spinning');
    clearWinLines();clearPremiumGlow();
    document.getElementById('win-overlay').classList.remove('show','mega','big');
    document.getElementById('ui-win').textContent='0.00';
    document.getElementById('ui-win').classList.remove('win-active');
    updateFreeSpinHUD();

    const grid=genFreeSpinOutcome(),res=evalSpin(grid);
    await animateReels(grid);
    currentGrid=grid;startPremiumGlow(grid);

    const winAmt=res.mult*freeSpinsBet*freeSpinsMultiplier;
    if(winAmt>0){
        freeSpinsTotalWin+=winAmt;balance+=winAmt;totalWon+=winAmt;
        if(res.wins.length>0){drawWL(res.wins);spawnWinP(res.wins);}
        const ov=document.getElementById('win-overlay');
        const amtEl=document.getElementById('win-amount');
        const subEl=document.getElementById('win-sub');
        const mult=winAmt/freeSpinsBet;
        ov.classList.remove('show','mega','big');void ov.offsetWidth;
        const gw=document.getElementById('game-wrapper');gw.classList.remove('shake-big','shake-mega');void gw.offsetWidth;
        if(winAmt>=freeSpinsBet*50){document.getElementById('win-label').textContent='‚ö° MEGA WIN ‚ö°';ov.classList.add('mega');spawnMega();subEl.textContent=Math.round(mult)+'√ó ('+freeSpinsMultiplier+'√ó MULTI)';SFX.winMega();gw.classList.add('shake-mega');}
        else if(winAmt>=freeSpinsBet*10){document.getElementById('win-label').textContent='‚ú¶ BIG WIN ‚ú¶';ov.classList.add('big');subEl.textContent=Math.round(mult)+'√ó ('+freeSpinsMultiplier+'√ó MULTI)';SFX.winBig();gw.classList.add('shake-big');}
        else{document.getElementById('win-label').textContent='WIN';subEl.textContent=freeSpinsMultiplier+'√ó MULTIPLIER';SFX.winSmall();}
        const countDur=winAmt>=freeSpinsBet*10?1200:700;const countStart=performance.now();
        function countUp(now){const p=Math.min((now-countStart)/countDur,1);const ease=1-Math.pow(1-p,3);amtEl.textContent='$'+(winAmt*ease).toFixed(2);if(p<1)requestAnimationFrame(countUp);}
        requestAnimationFrame(countUp);
        ov.classList.add('show');
        document.getElementById('ui-win').textContent=winAmt.toFixed(2);
        document.getElementById('ui-win').classList.add('win-active');
        setTimeout(()=>ov.classList.remove('show','mega','big'),2000);
    }

    updateFreeSpinHUD();updateUI();
    spinning=false;btn.disabled=false;btn.classList.remove('spinning');
    document.getElementById('spin-btn-wrap').classList.remove('spinning');

    // Retrigger check: 3+ scatters during free spins add more spins (cap 50)
    if(res.sc>=3&&freeSpinsRemaining+freeSpinsCount<50){
        const extra=FREE_SPIN_AWARDS[res.sc]||5;
        freeSpinsRemaining+=extra;freeSpinsTotalAwarded+=extra;
        SFX.bonusTrigger();
        const intro=document.getElementById('freespin-intro-overlay');
        document.getElementById('freespin-intro-count').textContent='+'+extra;
        document.getElementById('freespin-intro-mult').textContent='RETRIGGER!';
        intro.classList.add('active');
        await new Promise(r=>setTimeout(r,2000));
        intro.classList.remove('active');
        updateFreeSpinHUD();
    }

    const delay=isSuperTurbo()?150:isTurbo()?400:800;
    setTimeout(()=>doFreeSpin(),delay);
}

async function endFreeSpins(){
    document.getElementById('freespin-hud').classList.remove('active');
    document.getElementById('canvas-container').classList.remove('freespin-active');
    SFX.bonusCollect();
    const ov=document.getElementById('win-overlay');
    ov.classList.remove('show','mega','big');void ov.offsetWidth;
    document.getElementById('win-label').textContent='‚ö° FREE SPINS COMPLETE ‚ö°';
    document.getElementById('win-sub').textContent=freeSpinsCount+' SPINS √ó '+freeSpinsMultiplier+'x';
    const amtEl=document.getElementById('win-amount');
    const cStart=performance.now();
    function cUp(now){const p=Math.min((now-cStart)/1400,1);amtEl.textContent='$'+(freeSpinsTotalWin*(1-Math.pow(1-p,3))).toFixed(2);if(p<1)requestAnimationFrame(cUp);}
    requestAnimationFrame(cUp);
    ov.classList.add('show','mega');spawnMega();
    document.getElementById('ui-win').textContent=freeSpinsTotalWin.toFixed(2);
    document.getElementById('ui-win').classList.add('win-active');
    await new Promise(r=>setTimeout(r,3500));
    ov.classList.remove('show','mega','big');
    inFreeSpins=false;inBonus=false;
    // Restore super turbo if it was on before free spins
    if(speedModeBeforeFS>=0){speedMode=speedModeBeforeFS;speedModeBeforeFS=-1;updateSpeedBtns();}
    spinsSinceLastScatterBonus=0;
    nextScatterAt=25+Math.floor(Math.random()*51);
    updateUI();
    if(autoplay&&autoSpinsLeft>0&&balance>=bet){setTimeout(()=>doSpin(),isSuperTurbo()?100:isTurbo()?300:700);}else if(autoplay&&autoSpinsLeft<=0){stopAutoSpin();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sparkleBtn(){
    const btn=document.getElementById('spin-btn');
    const rect=btn.getBoundingClientRect();
    const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    const colors=['#00f0ff','#ff00aa','#b400ff','#ffe600','#00ff88','#ffffff'];
    for(let i=0;i<14;i++){
        const dot=document.createElement('div');
        dot.className='sparkle-dot';
        const angle=Math.random()*Math.PI*2;
        const dist=36+Math.random()*40;
        const dx=Math.cos(angle)*dist, dy=Math.sin(angle)*dist;
        dot.style.cssText=`left:${cx-2}px;top:${cy-2}px;background:${colors[i%colors.length]};box-shadow:0 0 6px ${colors[i%colors.length]};--dx:${dx}px;--dy:${dy}px;animation-duration:${0.4+Math.random()*0.5}s;`;
        document.body.appendChild(dot);
        setTimeout(()=>dot.remove(),900);
    }
    btn.classList.add('sparkle-ring');
    setTimeout(()=>btn.classList.remove('sparkle-ring'),600);
}

async function doSpin(){
    if(spinning||inBonus||balance<bet)return;
    spinning=true;
    if(autoplay){if(autoSpinsLeft!==Infinity)autoSpinsLeft--;updateAutoHud();}
    SFX.spinStart();
    const btn=document.getElementById('spin-btn');btn.disabled=true;btn.classList.add('spinning');
    document.getElementById('spin-btn-wrap').classList.add('spinning');
    clearWinLines();
    clearPremiumGlow();
    document.getElementById('win-overlay').classList.remove('show','mega');
    document.getElementById('ui-win').textContent='0.00';
    document.getElementById('ui-win').classList.remove('win-active');

    balance-=bet;totalBet+=bet;
    spinsSinceBonus++;spinsSinceLastScatterBonus++;
    updateBonusMeter();updateUI();

    const grid=genOutcome(),res=evalSpin(grid);
    await animateReels(grid);
    currentGrid=grid;
    startPremiumGlow(grid);

    const winAmt=res.mult*bet;
    if(winAmt>0){
        balance+=winAmt;totalWon+=winAmt;
        if(res.wins.length>0){drawWL(res.wins);spawnWinP(res.wins);}
        const ov=document.getElementById('win-overlay');
        const amtEl=document.getElementById('win-amount');
        const subEl=document.getElementById('win-sub');
        const mult=winAmt/bet;
        ov.classList.remove('show','mega','big');
        /* Force reflow for animation restart */
        void ov.offsetWidth;
        const gw=document.getElementById('game-wrapper');gw.classList.remove('shake-big','shake-mega');void gw.offsetWidth;
        if(winAmt>=bet*50){document.getElementById('win-label').textContent='‚ö° MEGA WIN ‚ö°';ov.classList.add('mega');spawnMega();subEl.textContent=Math.round(mult)+'√ó YOUR BET';SFX.winMega();gw.classList.add('shake-mega');}
        else if(winAmt>=bet*10){document.getElementById('win-label').textContent='‚ú¶ BIG WIN ‚ú¶';ov.classList.add('big');subEl.textContent=Math.round(mult)+'√ó YOUR BET';SFX.winBig();gw.classList.add('shake-big');}
        else{document.getElementById('win-label').textContent='WIN';subEl.textContent=mult>=3?Math.round(mult)+'√ó YOUR BET':'';SFX.winSmall();}
        /* Counting animation */
        const countDur=winAmt>=bet*10?1200:700;
        const countStart=performance.now();
        function countUp(now){
            const p=Math.min((now-countStart)/countDur,1);
            const ease=1-Math.pow(1-p,3);
            amtEl.textContent='$'+(winAmt*ease).toFixed(2);
            if(p<1)requestAnimationFrame(countUp);
        }
        requestAnimationFrame(countUp);
        /* Spawn coin particles */
        const gc=document.getElementById('game-wrapper');
        const colors=['#ffe600','#00f0ff','#ff00aa','#fff','#ffaa00'];
        for(let i=0;i<(winAmt>=bet*10?30:14);i++){
            const coin=document.createElement('div');coin.className='win-coin';
            const a=Math.random()*Math.PI*2,r=60+Math.random()*120;
            coin.style.cssText=`left:50%;top:45%;background:${colors[i%colors.length]};box-shadow:0 0 8px ${colors[i%colors.length]};--cx:${Math.cos(a)*r}px;--cy:${Math.sin(a)*r}px;animation-duration:${0.6+Math.random()*0.6}s;`;
            gc.appendChild(coin);setTimeout(()=>coin.remove(),1400);
        }
        ov.classList.add('show');
        document.getElementById('ui-win').textContent=winAmt.toFixed(2);
        document.getElementById('ui-win').classList.add('win-active');
        setTimeout(()=>ov.classList.remove('show','mega','big'),2600);
    }

    updateUI();spinning=false;btn.disabled=false;btn.classList.remove('spinning');
    document.getElementById('spin-btn-wrap').classList.remove('spinning');
    sparkleBtn();

    // Scatter free spins check (priority)
    if(res.sc>=3){
        await new Promise(r=>setTimeout(r,800));
        triggerFreeSpins(res.sc);
        return;
    }

    // Vault bonus check (meter-based)
    if(spinsSinceBonus>=nextBonusAt){
        await new Promise(r=>setTimeout(r,600));
        startBonus();
        return;
    }

    if(autoplay&&autoSpinsLeft>0&&balance>=bet){setTimeout(()=>doSpin(),isSuperTurbo()?100:isTurbo()?300:700);}else if(autoplay&&autoSpinsLeft<=0){stopAutoSpin();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUI(){
    document.getElementById('ui-balance').textContent=balance.toFixed(2);
    document.getElementById('ui-bet').textContent=bet.toFixed(2);
    document.getElementById('info-rtp').textContent=totalBet>0?((totalWon/totalBet)*100).toFixed(1)+'%':'‚Äî';
}

document.getElementById('spin-btn').addEventListener('click',doSpin);
document.getElementById('bet-up').addEventListener('click',()=>{if(!spinning&&!inBonus){betIdx=Math.min(betIdx+1,BETS.length-1);bet=BETS[betIdx];SFX.click();updateUI();}});
document.getElementById('bet-dn').addEventListener('click',()=>{if(!spinning&&!inBonus){betIdx=Math.max(betIdx-1,0);bet=BETS[betIdx];SFX.click();updateUI();}});
// Auto spin system
let turboAutoMode=false; // true when turbo/sturbo started continuous spinning
function updateAutoHud(){
    const hud=document.getElementById('auto-hud');
    const rem=document.getElementById('auto-remaining');
    if(autoplay&&autoSpinsLeft>0){
        hud.classList.add('show');
        rem.textContent=turboAutoMode?(speedMode===2?'S.TURBO':'TURBO'):(autoSpinsLeft===Infinity?'‚àû':autoSpinsLeft);
    }else{
        hud.classList.remove('show');
    }
    document.getElementById('btn-auto').classList.toggle('active',autoplay&&!turboAutoMode);
}
function stopAutoSpin(){
    if(turboAutoMode){speedMode=0;turboAutoMode=false;updateSpeedBtns();}
    autoplay=false;autoSpinsLeft=0;autoSpinsTotal=0;
    updateAutoHud();
    document.getElementById('auto-picker').classList.remove('open');
}
document.getElementById('btn-auto').addEventListener('click',()=>{
    if(autoplay){stopAutoSpin();return;}
    document.getElementById('auto-picker').classList.toggle('open');
});
document.querySelectorAll('.auto-pick-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        const count=parseInt(btn.dataset.spins);
        autoSpinsLeft=count;autoSpinsTotal=count;autoplay=true;
        document.getElementById('auto-picker').classList.remove('open');
        document.getElementById('spin-menu').classList.remove('open');
        document.getElementById('spin-menu-toggle').classList.remove('open');
        updateAutoHud();
        if(!spinning&&!inBonus)doSpin();
    });
});
document.getElementById('auto-stop-btn').addEventListener('click',()=>{stopAutoSpin();});
function updateSpeedBtns(){
    const tb=document.getElementById('btn-turbo'),st=document.getElementById('btn-sturbo');
    tb.classList.toggle('active',speedMode===1);
    st.classList.toggle('active',speedMode===2);st.classList.toggle('sturbo',speedMode===2);
}
document.getElementById('btn-turbo').addEventListener('click',()=>{
    SFX.click();
    if(speedMode===1){stopAutoSpin();return;}
    if(autoplay)stopAutoSpin();
    speedMode=1;turboAutoMode=true;autoplay=true;autoSpinsLeft=Infinity;
    updateSpeedBtns();updateAutoHud();
    document.getElementById('spin-menu').classList.remove('open');
    document.getElementById('spin-menu-toggle').classList.remove('open');
    if(!spinning&&!inBonus)doSpin();
});
document.getElementById('btn-sturbo').addEventListener('click',()=>{
    SFX.click();
    if(speedMode===2){stopAutoSpin();return;}
    if(autoplay)stopAutoSpin();
    speedMode=2;turboAutoMode=true;autoplay=true;autoSpinsLeft=Infinity;
    updateSpeedBtns();updateAutoHud();
    document.getElementById('spin-menu').classList.remove('open');
    document.getElementById('spin-menu-toggle').classList.remove('open');
    if(!spinning&&!inBonus)doSpin();
});
document.getElementById('btn-mute').addEventListener('click',()=>{const m=SFX.toggleMute();document.getElementById('btn-mute').textContent=m?'üîá':'üîä';document.getElementById('btn-mute').classList.toggle('active',m);});
document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();doSpin();}});

// Spin menu toggle
const spinMenu=document.getElementById('spin-menu'),spinMenuToggle=document.getElementById('spin-menu-toggle');
spinMenuToggle.addEventListener('click',e=>{e.stopPropagation();SFX.click();spinMenu.classList.toggle('open');spinMenuToggle.classList.toggle('open');});
document.addEventListener('click',e=>{if(!spinMenu.contains(e.target)&&e.target!==spinMenuToggle){spinMenu.classList.remove('open');spinMenuToggle.classList.remove('open');}});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
app.ticker.add(delta=>{
    const t=performance.now();
    // Slow breathing zoom on background (30s full cycle)
    const bgScale=1+0.03*Math.sin(t*0.0002094);
    bgSprite.scale.set(bgScale*W/bgSprite.texture.width,bgScale*H/bgSprite.texture.height);
    // Neon flicker - irregular alpha pulsing
    const f1=0.6+0.4*Math.sin(t*0.001)*Math.sin(t*0.00037);
    const f2=0.5+0.5*Math.sin(t*0.0008+1.5)*Math.sin(t*0.00053+0.7);
    const f3=0.55+0.45*Math.sin(t*0.0012+3.0)*Math.sin(t*0.00041+2.1);
    neonGlow1.alpha=f1;neonGlow2.alpha=f2;neonGlow3.alpha=f3;
    // Dust motes
    dustMotes.forEach(d=>d.update(delta));
    ambParts.forEach(p=>p.update(delta));
    drawAmbientLines();
    drawGlow(t);
    parts.forEach(p=>p.update());
    parts=parts.filter(p=>{if(!p.alive){p.destroy();return false;}return true;});
    updatePremiumGlow(delta);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUY BONUS FEATURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let enhancedNextSpin=false;

function openBuyBonus(){
    if(spinning||inBonus||inFreeSpins)return;
    const overlay=document.getElementById('buy-bonus-overlay');
    const enhCost=(bet*2).toFixed(2);
    const fsCost=(bet*100).toFixed(2);
    document.getElementById('bb-enhanced-cost').textContent='$'+enhCost;
    document.getElementById('bb-freespin-cost').textContent='$'+fsCost;
    document.getElementById('bb-buy-enhanced').disabled=balance<bet*2;
    document.getElementById('bb-buy-freespins').disabled=balance<bet*100;
    overlay.classList.add('active');
}

function closeBuyBonus(){
    document.getElementById('buy-bonus-overlay').classList.remove('active');
}

function genEnhancedOutcome(){
    const grid=[];
    const boostedStrips=STRIPS.map(strip=>{
        const boosted=[...strip];
        // Add extra wilds and scatters
        for(let i=0;i<4;i++)boosted.push('W');
        for(let i=0;i<3;i++)boosted.push('S');
        return boosted;
    });
    for(let r=0;r<REELS;r++){
        const strip=boostedStrips[r];
        const stop=Math.floor(Math.random()*strip.length);
        const len=strip.length;
        grid.push([strip[stop%len],strip[(stop+1)%len],strip[(stop+2)%len]]);
    }
    // Ensure at least one wild appears
    let hasWild=false;
    for(let r=0;r<REELS;r++)for(let row=0;row<ROWS;row++)if(grid[r][row]==='W')hasWild=true;
    if(!hasWild){
        const r=Math.floor(Math.random()*REELS);
        const row=Math.floor(Math.random()*ROWS);
        grid[r][row]='W';
    }
    return grid;
}

function buyEnhancedSpin(){
    const cost=bet*2;
    if(balance<cost||spinning||inBonus||inFreeSpins)return;
    balance-=cost;totalBet+=cost;
    enhancedNextSpin=true;
    closeBuyBonus();
    SFX.click();
    updateUI();
    // Auto-trigger the spin
    doEnhancedSpin();
}

async function doEnhancedSpin(){
    if(spinning||inBonus)return;
    spinning=true;
    SFX.spinStart();
    const btn=document.getElementById('spin-btn');btn.disabled=true;btn.classList.add('spinning');
    document.getElementById('spin-btn-wrap').classList.add('spinning');
    clearWinLines();clearPremiumGlow();
    document.getElementById('win-overlay').classList.remove('show','mega','big');
    document.getElementById('ui-win').textContent='0.00';
    document.getElementById('ui-win').classList.remove('win-active');
    spinsSinceBonus++;spinsSinceLastScatterBonus++;
    updateBonusMeter();updateUI();

    const grid=genEnhancedOutcome(),res=evalSpin(grid);
    enhancedNextSpin=false;
    await animateReels(grid);
    currentGrid=grid;startPremiumGlow(grid);

    const winAmt=res.mult*bet;
    if(winAmt>0){
        balance+=winAmt;totalWon+=winAmt;
        if(res.wins.length>0){drawWL(res.wins);spawnWinP(res.wins);}
        const ov=document.getElementById('win-overlay');
        const amtEl=document.getElementById('win-amount');
        const subEl=document.getElementById('win-sub');
        const mult=winAmt/bet;
        ov.classList.remove('show','mega','big');void ov.offsetWidth;
        const gw=document.getElementById('game-wrapper');gw.classList.remove('shake-big','shake-mega');void gw.offsetWidth;
        if(winAmt>=bet*50){document.getElementById('win-label').textContent='‚ö° MEGA WIN ‚ö°';ov.classList.add('mega');spawnMega();subEl.textContent=Math.round(mult)+'√ó YOUR BET';SFX.winMega();gw.classList.add('shake-mega');}
        else if(winAmt>=bet*10){document.getElementById('win-label').textContent='‚ú¶ BIG WIN ‚ú¶';ov.classList.add('big');subEl.textContent=Math.round(mult)+'√ó YOUR BET';SFX.winBig();gw.classList.add('shake-big');}
        else{document.getElementById('win-label').textContent='WIN';subEl.textContent=mult>=3?Math.round(mult)+'√ó YOUR BET':'';SFX.winSmall();}
        const countDur=winAmt>=bet*10?1200:700;const countStart=performance.now();
        function countUp(now){const p=Math.min((now-countStart)/countDur,1);const ease=1-Math.pow(1-p,3);amtEl.textContent='$'+(winAmt*ease).toFixed(2);if(p<1)requestAnimationFrame(countUp);}
        requestAnimationFrame(countUp);
        const gc=document.getElementById('game-wrapper');
        const colors=['#ffe600','#00f0ff','#ff00aa','#fff','#ffaa00'];
        for(let i=0;i<(winAmt>=bet*10?30:14);i++){
            const coin=document.createElement('div');coin.className='win-coin';
            const a=Math.random()*Math.PI*2,r2=60+Math.random()*120;
            coin.style.cssText='left:50%;top:45%;background:'+colors[i%colors.length]+';box-shadow:0 0 8px '+colors[i%colors.length]+';--cx:'+Math.cos(a)*r2+'px;--cy:'+Math.sin(a)*r2+'px;animation-duration:'+(0.6+Math.random()*0.6)+'s;';
            gc.appendChild(coin);setTimeout(()=>coin.remove(),1400);
        }
        ov.classList.add('show');
        document.getElementById('ui-win').textContent=winAmt.toFixed(2);
        document.getElementById('ui-win').classList.add('win-active');
        setTimeout(()=>ov.classList.remove('show','mega','big'),2600);
    }

    updateUI();spinning=false;btn.disabled=false;btn.classList.remove('spinning');
    document.getElementById('spin-btn-wrap').classList.remove('spinning');
    sparkleBtn();

    if(res.sc>=3){await new Promise(r=>setTimeout(r,800));triggerFreeSpins(res.sc);return;}
    if(spinsSinceBonus>=nextBonusAt){await new Promise(r=>setTimeout(r,600));startBonus();return;}
}

function buyFreeSpins(){
    const cost=bet*100;
    if(balance<cost||spinning||inBonus||inFreeSpins)return;
    balance-=cost;totalBet+=cost;
    closeBuyBonus();
    SFX.click();
    updateUI();
    // Trigger free spins directly with 3-scatter params (10 spins, 3x mult)
    setTimeout(()=>triggerFreeSpins(3),300);
}

document.getElementById('buy-bonus-btn').addEventListener('click',()=>{SFX.click();openBuyBonus();});
document.getElementById('bb-close').addEventListener('click',()=>{SFX.click();closeBuyBonus();});
document.getElementById('bb-buy-enhanced').addEventListener('click',buyEnhancedSpin);
document.getElementById('bb-buy-freespins').addEventListener('click',buyFreeSpins);
document.getElementById('buy-bonus-overlay').addEventListener('click',(e)=>{if(e.target.id==='buy-bonus-overlay')closeBuyBonus();});

initGrid();updateBonusMeter();updateUI();
document.querySelectorAll('.meter-segment').forEach((s,i)=>s.style.setProperty('--seg-index',i));
</script>
</body>
</html>
